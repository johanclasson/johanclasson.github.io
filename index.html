<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Johan Classon Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Johan Classon Blog">
<meta property="og:url" content="https://blog.classon.eu/index.html">
<meta property="og:site_name" content="Johan Classon Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Johan Classon">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Johan Classon Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Johan Classon Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.classon.eu"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2019-05-31-Release-Notes-with-Azure-DevOps" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019-05-31-Release-Notes-with-Azure-DevOps/" class="article-date">
  <time datetime="2019-05-30T22:00:00.000Z" itemprop="datePublished">2019-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019-05-31-Release-Notes-with-Azure-DevOps/">Release Notes With Azure DevOps</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The process that suites your team best might be different from what might be best for someone else. In this blog post, I would like to share how you can construct release notes with Azure DevOps in a nice ordered fashion.</p>
<p>When you need to publish release notes you might be facing difficulties such as:</p>
<ul>
<li>How to make them awesome (!).</li>
<li>How to reach your audience.</li>
<li>How to be as effective as possible.</li>
</ul>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR;"></a>TL;DR;</h2><p>1)    Write release notes in Product Backlog Items (PBIs).<br>2)    Collect release notes from PBIs into a Markdown document.<br>3)    Review by pull request (PR).<br>4)    Publish.</p>
<h2 id="Making-Them-Awesome"><a href="#Making-Them-Awesome" class="headerlink" title="Making Them Awesome"></a>Making Them Awesome</h2><h3 id="What-Changes-Have-Been-Introduced-Since-Last-Release"><a href="#What-Changes-Have-Been-Introduced-Since-Last-Release" class="headerlink" title="What Changes Have Been Introduced Since Last Release?"></a>What Changes Have Been Introduced Since Last Release?</h3><p>Obviously, you need some way to find out which changes that have been made, and also, which of those that are candidates to be included in the release notes. </p>
<p>Just prior to the release, you could construct a list of all changes manually, for example by summarizing the pushed commits. This approach is optimal if your team works in an ad-hoc fashion or without planning.</p>
<p>If you really want to, you can diff what code that changed since last release, and then write the release notes with that as guidance.</p>
<p>You might be tempted to use a Git repository log as reference, be aware of that commit messages might not be the best source of information for release notes since they are often written for other developers! If developers are indeed your target audience, you could just as well direct them to your repository instead of summarizing its log in a document somewhere.</p>
<p>My point here is that I do not recommend you relying on a tool for summarizing your release notes. By just planning a little you will have your summary already. For example, if you decide beforehand what to include in a release, then you will already have a nice list of what to include in the release notes. </p>
<h3 id="What-Changes-Might-Be-of-Importance-to-the-Audience-and-What-Changes-Might-Not"><a href="#What-Changes-Might-Be-of-Importance-to-the-Audience-and-What-Changes-Might-Not" class="headerlink" title="What Changes Might Be of Importance to the Audience, and What Changes Might Not?"></a>What Changes Might Be of Importance to the Audience, and What Changes Might Not?</h3><p>In Azure DevOps I plan my releases with PBI work items. I have found it convenient to include a custom boolean field in the PBI that I can then use for making a query to select just the right PBIs to include in the release notes.</p>
<p>If you have different audiences, you can consider adding multiple boolean fields, one for each audience.</p>
<p>How to add custom fields to work items are described in the official <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/settings/work/customize-process-field?view=azure-devops" target="_blank" rel="noopener">Azure DevOps documentation</a>.</p>
<h3 id="How-Can-You-Make-Sure-That-the-Information-in-the-Release-Notes-Are-Correct"><a href="#How-Can-You-Make-Sure-That-the-Information-in-the-Release-Notes-Are-Correct" class="headerlink" title="How Can You Make Sure That the Information in the Release Notes Are Correct?"></a>How Can You Make Sure That the Information in the Release Notes Are Correct?</h3><p>In my opinion, the ones best qualified to describe a change is probably the ones that have implemented it. This means that I do not think that it is a good idea to let just a few people write the release notes. Instead you should have your whole team engaged in writing them.</p>
<p>You might think that this is overkill, but in the best of worlds, I think that you would benefit from writing the release notes for a PBI before you start implementing it. The idea is to force you to think about the end-user or customer’s perspective as early as possible in your development process.</p>
<p>I recommend that you include custom text-fields for release notes directly in the PBI. That way it will be easy to find where to write. Here is an example.</p>
<p><img src="/2019-05-31-Release-Notes-with-Azure-DevOps/PBI-release-notes-fields.png" alt="PBI custom fields for making release notes with Azure DevOps"></p>
<p>If your team do not commit to writing release notes beforehand, you could add a reminder for everyone to finish their release notes by including it in your team’s definition of done.</p>
<h3 id="How-to-Make-the-Release-Notes-Readable"><a href="#How-to-Make-the-Release-Notes-Readable" class="headerlink" title="How to Make the Release Notes Readable?"></a>How to Make the Release Notes Readable?</h3><p>Of course you can make a best effort writing nice readable descriptions for each PBI. I imagine this is a matter of personal opinion, but I think it is hard to make proof-reeding when I only have the release notes from a single PBI on the screen. Therefore, I like to collect all release notes from the PBIs into a single document before the review process begins.</p>
<p>I treat that single document as the final product, and hence I often do not care to update the descriptions in the PBIs. These can be seen upon as just history if you will.</p>
<p>You can find an example how to generate release notes in Markdown format using PowerShell in <a href="https://gist.github.com/johanclasson/027f49ef0bf9e924927554b4926266bd" target="_blank" rel="noopener">this gist</a>. The script iterates all work items returned by a query and constructs the document content from the custom title- and description-fields in those.</p>
<p>Here is an example of how to use it:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$content</span> = .\<span class="built_in">Get-ReleaseNotes</span>.ps1 <span class="literal">-Pat</span> <span class="string">'abc123'</span> <span class="literal">-Organization</span> <span class="string">'Fabrikam'</span> <span class="literal">-Project</span> <span class="string">'Fiber'</span> <span class="literal">-Query</span> <span class="string">'My Queries/Release Notes'</span></span><br><span class="line"><span class="variable">$utf8NoBomEncoding</span> = <span class="built_in">New-Object</span> System.Text.UTF8Encoding <span class="variable">$False</span></span><br><span class="line"><span class="variable">$path</span> = <span class="built_in">Join-Path</span> (<span class="built_in">Resolve-Path</span> .\notes) sprint<span class="literal">-11</span>.md</span><br><span class="line">[<span class="type">System.IO.File</span>]::WriteAllLines(<span class="variable">$path</span>, <span class="variable">$content</span>, <span class="variable">$utf8NoBomEncoding</span>) <span class="comment"># Outputs UTF8 without BOM</span></span><br></pre></td></tr></table></figure>

<p>My format of choice for release notes is Markdown, and that is because of the following reasons.</p>
<ul>
<li>Markdown is a perfect format for making reviews through PRs to a Git repository.</li>
<li>It is relatively easy to convert Markdown into whatever format you need to publish in.</li>
</ul>
<p>I would like to stress that the more people that are engaged in both writing and reviewing release notes the better they become. In addition to involving technical experts in the review process, I also like to have generally skilled writers review the document at least once before it is published.</p>
<h2 id="How-to-Reach-Your-Audience"><a href="#How-to-Reach-Your-Audience" class="headerlink" title="How to Reach Your Audience"></a>How to Reach Your Audience</h2><p>Difference audiences a best reached by different means. For example, if you do not have direct contact with your end users you might want to publish your release notes as HTML on your product’s website. Or if your audience does not actively search for release notes you might want to consider publishing your release notes as a PDF-file which you mail to your end users.</p>
<p>If you would like to be fancy, you can integrate the release notes into the actual product so that your end users can pull up-, or are presented with-, the release notes just as they use the new version of your product the first time.</p>
<h2 id="How-to-Be-as-Effective-as-Possible"><a href="#How-to-Be-as-Effective-as-Possible" class="headerlink" title="How to Be as Effective as Possible"></a>How to Be as Effective as Possible</h2><p>Doing all of this planning, PBI-tinkering and reviewing might seem like a lot of work. But I hope that you might soon realize that it is indeed less work compared to manually construct release notes in an ad-hoc fashion.</p>
<p>Also, when you write the release notes close to when you design or implement a change, then you do not have to spend as much time figuring out what to write.</p>
<p>I think that being effective is not only about spending less time writing release notes, but also that you also produce content with high quality. The review process is essential to archive this. Please do not skip reviewing of your release notes!</p>
<p>If your teams are already familiar with doing PRs to review code, reviewing release notes in the same way should not be so complicated.</p>
<h2 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h2><p>Here I will summarize an example of how the overall process might look like. </p>
<p>The release notes owner manages a work item query which selects the work items which are meant to be included in the release notes.</p>
<p>An overview of the process around creating release notes is presented below.</p>
<p><img src="/2019-05-31-Release-Notes-with-Azure-DevOps/process-overview.png" alt="Process Overview"></p>
<h3 id="Two-Weeks-Prior-Release"><a href="#Two-Weeks-Prior-Release" class="headerlink" title="Two Weeks Prior Release"></a>Two Weeks Prior Release</h3><p>The release notes owner executes the query and mails its result to the team members who can see if some work items are missing or should be removed.</p>
<h3 id="One-Week-Prior-Release"><a href="#One-Week-Prior-Release" class="headerlink" title="One Week Prior Release"></a>One Week Prior Release</h3><p>When everyone has completed entering the release notes in the selected work items, the release notes owner generates a Markdown-file and starts a pull request. The team reviews the document, correcting mistakes until everyone agrees that the quality is high enough at which point the pull request is merged.</p>
<h3 id="Day-of-Release"><a href="#Day-of-Release" class="headerlink" title="Day of Release"></a>Day of Release</h3><p>The release notes owner triggers an automated process which converts the Markdown-file to various possible formats.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2019-05-31-Release-Notes-with-Azure-DevOps/" data-id="ck93prm0p0007u0yg30jm8h3q" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2018-11-29-Asynchronously-Wait-for-Task-to-Complete-with-Timeout" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018-11-29-Asynchronously-Wait-for-Task-to-Complete-with-Timeout/" class="article-date">
  <time datetime="2018-11-28T23:00:00.000Z" itemprop="datePublished">2018-11-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018-11-29-Asynchronously-Wait-for-Task-to-Complete-with-Timeout/">Asynchronously Wait for Task to Complete With Timeout</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I was recently working at an async method which could possibly hang if some dependent stuff did not happen. To prevent the method from hanging, I wanted to implement some kind of timeout. Now, how can I make a task abort, given the following method signature?</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SomeClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DoStuffAsync</span>(<span class="params">CancellationToken? ct = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Take-One-Task-Extension-Method"><a href="#Take-One-Task-Extension-Method" class="headerlink" title="Take One - Task Extension Method"></a>Take One - Task Extension Method</h2><p>The plan was to implement som kind of extension method to Task which could add the timeout-functionality.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TaskExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">TimeoutAfter</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">this</span> Task task, <span class="keyword">int</span> millisecondsTimeout, CancellationToken ct</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> completedTask = <span class="keyword">await</span> Task.WhenAny(</span><br><span class="line">            task, Task.Delay(millisecondsTimeout, ct));</span><br><span class="line">        <span class="keyword">if</span> (completedTask == task)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And use it like this.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SomeClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DoStuffAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        CancellationToken? ct = <span class="literal">null</span>, <span class="keyword">int</span> millisecondsTimeout = <span class="number">20</span>_0000</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">var</span> notNullCt = ct ?? CancellationToken.None;</span><br><span class="line">        <span class="keyword">await</span> DoStuffInnerAsync(notNullCt).TimeoutAfter(</span><br><span class="line">            millisecondsTimeout, notNullCt);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">DoStuffInnerAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This design allowed that the internal <code>Delay</code>-task would be cancelled if the user of my API canceled the method call. Nice! But it also had some mayor disadvantages:</p>
<ul>
<li>No task will be canceled if either of them finish successfully, which leads to having tasks running in the background for no reason, eating system resources.</li>
<li>I had to make sure to pass the same cancellation token both to <code>DoStuffInnerAsync</code> and <code>TimeoutAfter</code>, which might be something that could lead to mistakes further down.</li>
</ul>
<h2 id="Take-Two-Expanding-the-Extension-Method"><a href="#Take-Two-Expanding-the-Extension-Method" class="headerlink" title="Take Two - Expanding the Extension Method"></a>Take Two - Expanding the Extension Method</h2><p>To be able to cancel the <code>TimeoutAfter</code>-task i needed a <code>CancellationTokenSource</code>-instance, and pass its token to the <code>TimeoutAfter</code>-method. And I also wanted the <code>TimeoutAfter</code>-task to cancel if the user canceled the public API call.</p>
<p>This is what I came up with.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TaskExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">TimeoutAfter</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">this</span> Task task, <span class="keyword">int</span> millisecondsTimeout, CancellationToken ct</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> cts = <span class="keyword">new</span> CancellationTokenSource())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (ct.Register(() =&gt; cts.Cancel()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> completedTask = <span class="keyword">await</span> Task.WhenAny(</span><br><span class="line">                    task, Task.Delay(millisecondsTimeout, cts.Token));</span><br><span class="line">                <span class="keyword">if</span> (completedTask == task)</span><br><span class="line">                &#123;</span><br><span class="line">                    cts.Cancel();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();                    </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is some seriously dangerous programming.</p>
<ul>
<li>By subscribing to cancel-events with <code>ct.Register(...)</code> I opened upp the possibility for memory leaks if I do not unsubscribe somehow.</li>
<li>Also, using <code>cts</code> (which can be disposed) in the delegate passed to <code>ct.Register(...)</code> might actually make my application crash if <code>ct</code> was canceled outside of the <code>TimeOutAfter</code>-method scope.</li>
</ul>
<p><code>Register</code> returns a disposable something, which when disposed will unsubscribe. By adding the inner using-block, I fixed both of these problems.</p>
<p>This made it possible to cancel the <code>Delay</code>-task when the actual task completed, but not the reverse. How should I solve the bigger problem, how to cancel the actual task if it would hang? Eating up system resources indefinitely…</p>
<h2 id="Take-Three-Changing-the-Public-API"><a href="#Take-Three-Changing-the-Public-API" class="headerlink" title="Take Three - Changing the Public API"></a>Take Three - Changing the Public API</h2><p>With much hesitation I finally decided to make a breaking change to the public API by replacing the <code>CancellationToken</code> with a <code>CancellationTokenSource</code> in the <code>DoStuffAsync</code>-method.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SomeClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DoStuffAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        CancellationTokenSource cts = <span class="literal">null</span>, <span class="keyword">int</span> millisecondsTimeout = <span class="number">20</span>_0000</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">var</span> notNullCts = cts ?? <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line">        <span class="keyword">await</span> DoStuffInnerAsync(notNullCts.Token).TimeoutAfter(</span><br><span class="line">            millisecondsTimeout, notNullCts);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">DoStuffInnerAsync</span>(<span class="params">CancellationToken ct</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TaskExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">TimeoutAfter</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">this</span> Task task, <span class="keyword">int</span> millisecondsTimeout, CancellationTokenSource cts</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> completedTask = <span class="keyword">await</span> Task.WhenAny(</span><br><span class="line">            task, Task.Delay(millisecondsTimeout, cts.Token));</span><br><span class="line">        <span class="keyword">if</span> (completedTask == task)</span><br><span class="line">        &#123;</span><br><span class="line">            cts.Cancel();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cts.Cancel();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();                    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nice! But this still did not solve that I had make sure to pass the same <code>cts</code> to both the actual task and the <code>Delay</code>-task.</p>
<h2 id="Final-Solution-Doing-the-Obvious"><a href="#Final-Solution-Doing-the-Obvious" class="headerlink" title="Final Solution - Doing the Obvious"></a>Final Solution - Doing the Obvious</h2><p>Most things is really easy when you know the answer. By accident I stumbled upon that <code>CancellationTokenSource</code> has a <code>CancelAfter(...)</code>-method. This solves my problem entirely without the need to update my public API.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> SomeClient();</span><br><span class="line"><span class="keyword">var</span> cts = <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line">cts.CancelAfter(<span class="number">20</span>_000);</span><br><span class="line"><span class="keyword">await</span> client.DoStuffAsync(cts.Token);</span><br></pre></td></tr></table></figure>

<p>Easy peasy. I wish I had known about this earlier!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2018-11-29-Asynchronously-Wait-for-Task-to-Complete-with-Timeout/" data-id="ck93puyfp00006sygb3y36uth" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2018-06-29-Get-started-with-invisible-reCAPTCHA" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018-06-29-Get-started-with-invisible-reCAPTCHA/" class="article-date">
  <time datetime="2018-06-28T22:00:00.000Z" itemprop="datePublished">2018-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018-06-29-Get-started-with-invisible-reCAPTCHA/">Get Started With Invisible reCAPTCHA</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>To prevent software from posting forms on websites (and nowadays even on mobile apps), there is this <strong>C</strong>ompletely <strong>A</strong>utomated <strong>P</strong>ublic <strong>T</strong>uring test to tell <strong>C</strong>omputers and <strong>H</strong>umans <strong>A</strong>part, also known as CAPTCHA.</p>
<p>When I think about CAPTCHAs, I relate to trying to read distorted letters. I don?t know how you react, but I really dislike when I am forced to solve those. Lately I have seen a few variants such as differentiating cats from dogs, picking out road signs or other objects in more or less obscure images. Although I find them to be much more pleasant, I still think that they are a PITA.</p>
<p><a href="https://security.googleblog.com/2014/12/are-you-robot-introducing-no-captcha.html" target="_blank" rel="noopener">Late in 2014</a> Google announced their No CAPTCHA reCAPTCHA service using machine learning algorithms to detect whether a visitor is a bot or an actual person. While being much easier to use, I think it is kind of silly to have to tick a checkbox where I claim not to be a robot.</p>
<p>–</p>
<p>I must have been living under a rock the past year. I just recently found out that Google have an invisible version of their reCAPTCHA service, which was announced as early as <a href="https://security.googleblog.com/2017/06/making-internet-safer-and-faster.html" target="_blank" rel="noopener">march 2017</a>!</p>
<p>To get started:</p>
<p>1) <a href="https://www.google.com/recaptcha/admin" target="_blank" rel="noopener">Register for an API key</a></p>
<p>2) Include something similar to the following in your html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://www.google.com/recaptcha/api.js"</span> <span class="attr">async</span> <span class="attr">defer</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">onSubmit</span><span class="params">(token)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">"login-form"</span>).submit();</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"login-form"</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"g-recaptcha"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">data-sitekey</span>=<span class="string">"&#123;Insert API key here&#125;"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">data-callback</span>=<span class="string">"onSubmit"</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3) Validate the posted form parameter <code>g-recaptcha-response</code> service side by making a HTTP POST to <code>https://www.google.com/recaptcha/api/siteverify</code> with the query parameters <code>?secret={API secret}&amp;response={g-recaptcha-response}&amp;remoteip={Remote user IP}</code>.</p>
<p>The invisible reCAPTCHA is in my opinion a truly incredible service! Read more about it in <a href="https://developers.google.com/recaptcha/docs/invisible" target="_blank" rel="noopener">the official docs</a>, or <a href="https://www.google.com/recaptcha/api2/demo?invisible=true" target="_blank" rel="noopener">try the demo</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2018-06-29-Get-started-with-invisible-reCAPTCHA/" data-id="ck93ug7w1000jdsygeuv4ay8v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2018-05-09-Handle-Secrets-with-.NET-Core" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018-05-09-Handle-Secrets-with-.NET-Core/" class="article-date">
  <time datetime="2018-05-08T22:00:00.000Z" itemprop="datePublished">2018-05-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018-05-09-Handle-Secrets-with-.NET-Core/">Handle Secrets With .NET Core</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Have you ever checked in a configuration file with a secret? Now is the time for you to do something better. In this post, I will show four convenient ways in which configuration secrets can be stored outside of your source code repository.</p>
<h4 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h4><h5 id="NuGet-package-Microsoft-Extensions-Configuration-EnvironmentVariables"><a href="#NuGet-package-Microsoft-Extensions-Configuration-EnvironmentVariables" class="headerlink" title="NuGet-package Microsoft.Extensions.Configuration.EnvironmentVariables:"></a>NuGet-package Microsoft.Extensions.Configuration.EnvironmentVariables:</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> secret = builder</span><br><span class="line">    .AddEnvironmentVariables(prefix)</span><br><span class="line">    .Build()[key];</span><br></pre></td></tr></table></figure>

<h5 id="NuGet-package-Microsoft-Extensions-Configuration-UserSecrets"><a href="#NuGet-package-Microsoft-Extensions-Configuration-UserSecrets" class="headerlink" title="NuGet-package Microsoft.Extensions.Configuration.UserSecrets:"></a>NuGet-package Microsoft.Extensions.Configuration.UserSecrets:</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> secret = builder</span><br><span class="line">    .AddUserSecrets(userSecretsId)</span><br><span class="line">    .Build()[key];</span><br></pre></td></tr></table></figure>

<p>File with secrets at <code>%APPDATA%\Microsoft\UserSecrets\{userSecretsId}\secrets.json</code>.</p>
<h5 id="NuGet-package-Microsoft-Extensions-Configuration-AzureKeyVault"><a href="#NuGet-package-Microsoft-Extensions-Configuration-AzureKeyVault" class="headerlink" title="NuGet-package Microsoft.Extensions.Configuration.AzureKeyVault:"></a>NuGet-package Microsoft.Extensions.Configuration.AzureKeyVault:</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> secret = builder</span><br><span class="line">    .AddAzureKeyVault(vaultUrl, clientId, certificate)</span><br><span class="line">    .Build()[key];</span><br></pre></td></tr></table></figure>

<h5 id="NuGet-packages-Microsoft-Azure-KeyVault-and-Microsoft-Azure-Services-AppAuthentication"><a href="#NuGet-packages-Microsoft-Azure-KeyVault-and-Microsoft-Azure-Services-AppAuthentication" class="headerlink" title="NuGet-packages Microsoft.Azure.KeyVault and Microsoft.Azure.Services.AppAuthentication:"></a>NuGet-packages Microsoft.Azure.KeyVault and Microsoft.Azure.Services.AppAuthentication:</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> secret = <span class="keyword">await</span> <span class="keyword">new</span> KeyVaultClient(<span class="keyword">new</span> KeyVaultClient.AuthenticationCallback(</span><br><span class="line">    <span class="keyword">new</span> AzureServiceTokenProvider().KeyVaultTokenCallback))</span><br><span class="line">    .GetSecretAsync(vaultUrl, key);</span><br></pre></td></tr></table></figure>

<h2 id="Secrets-Stored-Locally"><a href="#Secrets-Stored-Locally" class="headerlink" title="Secrets Stored Locally"></a>Secrets Stored Locally</h2><p>Imagine that you are part of a team and that you work on developing some new system. Since the system depends on some back-end service you have a password in the systems .config- or .json configuration file, if not for something else, just so that you can to run the system on your local machine.</p>
<p>When you commit your code, you couple the access restrictions of the beck-end service to that of the repository. Or in other words, you will have to make sure that no one has access to the source code that is not allowed to access the back-end service.</p>
<p>Yes, you can always remove the password from the repository history, or even rotate the secret on the back-end service when development on your new system has stopped. But those two options might show to be quite cumbersome in practice.</p>
<p>A better option would have been to store the password on a location outside of your source code repository.</p>
<h3 id="Environment-Variables"><a href="#Environment-Variables" class="headerlink" title="Environment Variables"></a>Environment Variables</h3><p>Using environment variables to store secrets is a simple but effective solution. Since environment variables is a standardized mechanism that is available in <a href="https://en.wikipedia.org/wiki/Environment_variable" target="_blank" rel="noopener">most</a> operating systems, there is a wide range of tooling that can make your life easier. One example is Docker which has great support for setting environment variables for containers.</p>
<p>Here is an example of how to use the <code>AddEnvironmentVariables</code> extension method of the NuGet package <code>Microsoft.Extensions.Configuration.EnvironmentVariables</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder();</span><br><span class="line">        builder.AddEnvironmentVariables(<span class="string">"MYAPP_"</span>);</span><br><span class="line">        IConfiguration configuration = builder.Build();</span><br><span class="line">        Console.WriteLine(<span class="string">$"Ex1 EnvironmentVariables: <span class="subst">&#123;configuration[<span class="string">"MySecret"</span>]&#125;</span>"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In my opinion, it is a good practice to use a prefix filter. In the myriad of other environment variables, I find it nice to have the ones belonging to my apps grouped together. In my example above, the value of the variable with name <code>MYAPP_MYSECRET</code> will be available through <code>configuration[&quot;MySecret&quot;]</code>.</p>
<p>Also, a good feature is to group related variables into sections. When environment variables are added to the configuration instance, names with <code>__</code> are replaced with <code>:</code>. This enables <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?#suboptions-configuration" target="_blank" rel="noopener">getting sub sections, or/and using the options functionality</a>. </p>
<p>If you are used to get configuration values through a static resource such as the <code>ConfigurationManager</code> of the .NET ?Full? Framework, I recommend reading about <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection" target="_blank" rel="noopener">how dependency injection can be done with ASP.NET Core</a>, just to get you started with how to inject the configuration instance to where it is needed.</p>
<h3 id="User-Secrets"><a href="#User-Secrets" class="headerlink" title="User Secrets"></a>User Secrets</h3><p>Another option is to use the <code>AddUserSecrets</code> extension method of the NuGet package <code>Microsoft.Extensions.Configuration.UserSecrets</code>. It enforces that the secrets are stored in the AppData- or Home-directory.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder();</span><br><span class="line">        <span class="keyword">var</span> env = <span class="keyword">new</span> HostingEnvironment &#123; EnvironmentName = EnvironmentName.Development &#125;;</span><br><span class="line">        <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">        &#123;</span><br><span class="line">            builder.AddUserSecrets(<span class="string">"MyUserSecretsId"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        IConfiguration configuration = builder.Build();</span><br><span class="line">        Console.WriteLine(<span class="string">$"Ex2 UserSecrets: <span class="subst">&#123;configuration[<span class="string">"MySecret"</span>]&#125;</span>"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Secrets are read from a json-file located at <code>%APPDATA%\Microsoft\UserSecrets\{UserSecretsId}\secrets.json</code> on Windows or <code>~/.microsoft/usersecrets/{UserSecretsId}/secrets.json</code> on Linux. I find it most convenient to supply the application id directly in the <code>AddUserSecrets</code>-method, but you can <a href="https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?#installing-the-secret-manager-tool" target="_blank" rel="noopener">set the id in the .csproj-file</a> as well, or by using the assembly attribute like <code>[assembly:UserSecretsId(&quot;MyUserSecrets&quot;)]</code>. If you really want to do something hard core, you can set the UserSecretsId with a MSBuild property like <code>/p:UserSecretsId=MyUserSecrets</code>.</p>
<p>There is some <a href="https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?#installing-the-secret-manager-tool" target="_blank" rel="noopener">CLI tooling</a> ment help you manage the secrets.json file. But I find it so dead simple to create the secrets.json file manually that I seldom bother to use the CLI.</p>
<p>The content of secrests.json can be something like this:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"MySecret"</span>: <span class="string">"Some value"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Since it is not a good practice to have unencrypted secrets on the file system, I recommend only using <code>UserSecrets</code> for local development.</p>
<h2 id="Secrets-Stored-in-a-Shared-Location"><a href="#Secrets-Stored-in-a-Shared-Location" class="headerlink" title="Secrets Stored in a Shared Location"></a>Secrets Stored in a Shared Location</h2><p>Back to my imaginary development scenario.</p>
<p>All is working well, and every team member is productive running the system. Your team is making great progress. But then all of a sudden, the back-end service password is rotated for whatever reason, and productivity stops.</p>
<p>Of course, one could prioritize to take the time to prepare everyone in the team of the rotation. But if you don?t, your colleagues will get runtime exceptions when they run their system. When they have found out that the reason that they got access denied was because of a rotated password, they can finally get up to speed again. That is, if they are able to find out what the new password is.</p>
<p>A possible way to solve this is to store the password in a shared location such in a common database, which preferably is encrypted. That is a solution that works well, and it is normally not that hard to encrypt the passwords. At least not with SQL Server.</p>
<h3 id="Azure-Key-Vault"><a href="#Azure-Key-Vault" class="headerlink" title="Azure Key Vault"></a>Azure Key Vault</h3><p>An even better approach would be to use a product specialized for secrets distribution, such as Azure Key Vault (AKV). I think the tooling around AKV is great. Since it has a REST API, you can access it from most platforms, and there <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-keyvault-parameter" target="_blank" rel="noopener">is support in Azure Arm Templates</a> to get secrets from AKV when they are run. Besides usability, AKV is <a href="https://azure.microsoft.com/en-us/pricing/details/key-vault/" target="_blank" rel="noopener">not very expensive</a> to use for secrets. It is so cheap that I mostly consider it to be a free service.</p>
<p>For accessing secrets in AKV one needs to authenticate and pass in an access token. Applications that need to authenticate with Azure Active Directory (AAD) do so with credentials stored in service principals. If needed, an application can have many ways to authenticate, and each set of credentials is stored in a separate service principal.</p>
<p>Authentication with service principals are made with an application id and either a client secret or a certificate. So, which one is the better option?</p>
<p>Secrets might seem easy to use but have the drawback that they can be read. By using secrets, you again couple the access restrictions. This time, the coupling is between access to the settings of the application and to whatever resources that application is meant to access.</p>
<p>Certificates are in fact also relatively straight-forward to use. You can even generate a self-signed certificate and use that to create a service principal in AAD with just these few lines of PowerShell:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cert</span> = <span class="built_in">New-SelfSignedCertificate</span> <span class="literal">-CertStoreLocation</span> <span class="string">"cert:\CurrentUser\My"</span> `</span><br><span class="line">  <span class="literal">-Subject</span> <span class="string">"CN=my-application"</span> <span class="literal">-KeySpec</span> KeyExchange</span><br><span class="line"><span class="variable">$keyValue</span> = [<span class="type">System.Convert</span>]::ToBase64String(<span class="variable">$cert</span>.GetRawCertData())</span><br><span class="line"></span><br><span class="line"><span class="variable">$sp</span> = <span class="built_in">New-AzureRMADServicePrincipal</span> <span class="literal">-DisplayName</span> my<span class="literal">-application</span> `</span><br><span class="line">  <span class="literal">-CertValue</span> <span class="variable">$keyValue</span> <span class="literal">-EndDate</span> <span class="variable">$cert</span>.NotAfter <span class="literal">-StartDate</span> <span class="variable">$cert</span>.NotBefore</span><br><span class="line">Sleep <span class="number">20</span> <span class="comment"># Wait for service principal to be propagated throughout AAD</span></span><br><span class="line"><span class="built_in">New-AzureRmRoleAssignment</span> <span class="literal">-RoleDefinitionName</span> Contributor `</span><br><span class="line">  <span class="literal">-ServicePrincipalName</span> <span class="variable">$sp</span>.ApplicationId</span><br></pre></td></tr></table></figure>

<p>If you want a longer certificate validity than one year, use the argument <code>-NotAfter</code> for <code>New-SelfSignedCertificate</code>.</p>
<p>Here is an example of how to get a secret from AKV by using the <code>AddAzureKeyVault</code> extension method of the NuGet package <code>Microsoft.Extensions.Configuration.AzureKeyVault</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder();</span><br><span class="line">        builder.AddAzureKeyVault(</span><br><span class="line">            vault: <span class="string">"https://my-application-kv.vault.azure.net/"</span>,</span><br><span class="line">            clientId: <span class="string">"865f36f7-08c1-4ca2-97c9-a5a9cab56fd8"</span>,</span><br><span class="line">            certificate: GetCertificate());</span><br><span class="line">        IConfiguration configuration = builder.Build();</span><br><span class="line">        Console.WriteLine(<span class="string">$"Ex3 AzureKeyVault: <span class="subst">&#123;configuration[<span class="string">"MySecret"</span>]&#125;</span>"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> X509Certificate2 <span class="title">GetCertificate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">using</span> (X509Store store = <span class="keyword">new</span> X509Store(StoreLocation.CurrentUser))</span><br><span class="line">        &#123;</span><br><span class="line">            store.Open(OpenFlags.ReadOnly);</span><br><span class="line">            <span class="keyword">var</span> cers = store.Certificates.Find(</span><br><span class="line">                X509FindType.FindBySubjectName, <span class="string">"my-application"</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (cers.Count == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Could not find certificate!"</span>);</span><br><span class="line">            <span class="keyword">return</span> cers[<span class="number">0</span>];                </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For loading a certificate in an Azure App Service, add a <code>WEBSITE_LOAD_CERTIFICATES</code> app setting with the certificate thumbprint as value. For more details on this, read the <a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-web-ssl-cert-load#load-your-certificates" target="_blank" rel="noopener">official docs</a>.</p>
<p>When calling the <code>Build</code>-method, all secrets are read in from AKV at once and are then kept in the configuration. Secret names with <code>--</code> are replaced with <code>:</code> when they are read in.</p>
<h3 id="AppAuthentication-and-KeyVaultClient"><a href="#AppAuthentication-and-KeyVaultClient" class="headerlink" title="AppAuthentication and KeyVaultClient"></a>AppAuthentication and KeyVaultClient</h3><p>Just a few days ago, Microsoft released the NuGet package <code>Microsoft.Azure.Services.AppAuthentication</code>. It contains an <code>AzureServiceTokenProvider</code> that abstracts how to get an access token from AAD.<br>To use it together with the <code>KeyVaultClient</code> in the NuGet package <code>Microsoft.Azure.KeyVault</code>, you simply insert a callback method of the token provider in its constructor.</p>
<pre><code>public static class Program
{
    private static async Task Main()
    {
        var azureServiceTokenProvider = new AzureServiceTokenProvider();
        var keyVaultClient = new KeyVaultClient(
            new KeyVaultClient.AuthenticationCallback(
                azureServiceTokenProvider.KeyVaultTokenCallback));
        var secret = await keyVaultClient
            .GetSecretAsync(
                vaultBaseUrl: &quot;https://my-application-kv.vault.azure.net/&quot;,
                secretName: &quot;MySecret&quot;);        
        Console.WriteLine($&quot;Ex4 AppAuthentication: {secret.Value}&quot;);
    }
}</code></pre><p>To configure how <code>AzureServiceTokenProvider</code> will acquire tokens you can provide a connection string, either by passing it as a parameter in the constructor or by setting it as the environment variable <code>AzureServicesAuthConnectionString</code>. If no connection string is provided, such as in my example above, the <code>AzureServiceTokenProvider</code> will try three connection strings for you and pick one that works.</p>
<p>If you are using the NuGet package <code>Microsoft.Extensions.Configuration.AzureKeyVault</code> to get secrets from AKV, which I wrote about in the previous example, you need to have a service principal for local development, preferably with a certificate for authentication. Yes, you can use <code>Microsoft.Extensions.Configuration.EnvironmentVariables</code> or <code>Microsoft.Extensions.Configuration.UserSecrets</code> to add secrets. But as I mentioned before, distributing them in your team might be an unnecessary pain.</p>
<p><code>AzureServiceTokenProvider</code> solves this rather nice. You and your team members can use your own accounts for accessing AKV, and your production application can use its own account for accessing AKV. Everything is either picked out for you, or it can be configured at deploy-time.</p>
<p>I have tried to summarize the supported connection string types below for you. For full details see the <a href="https://docs.microsoft.com/en-us/azure/key-vault/service-to-service-authentication#connection-string-support" target="_blank" rel="noopener">official documentation</a>.</p>
<h4 id="Local-development"><a href="#Local-development" class="headerlink" title="Local development"></a>Local development</h4><p>For local development scenarios, credentials can be taken from a live Azure CLI session, a logged in user in Visual Studio, or the local user account on a computer that is joined to the domain of the AKV.</p>
<ul>
<li>RunAs=Developer; DeveloperTool=AzureCli</li>
<li>RunAs=Developer; DeveloperTool=VisualStudio</li>
<li>RunAs=CurrentUser;</li>
</ul> Since Visual Studio 2017 Update 6 you can set the account under Tools -> Azure Service Authentication.

<p>If you are not using Visual Studio, <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" target="_blank" rel="noopener">Azure CLI 2.0</a> is the fallback. Run <code>az login</code> and go!</p>
<h4 id="Service-Principals"><a href="#Service-Principals" class="headerlink" title="Service Principals"></a>Service Principals</h4><ul>
<li>RunAs=App;AppId={AppId};TenantId=NotUsed;CertificateThumbprint={Thumbprint};CertificateStoreLocation={LocalMachine or CurrentUser}</li>
<li>RunAs=App;AppId={AppId};TenantId=NotUsed;CertificateSubjectName={Subject};CertificateStoreLocation={LocalMachine or CurrentUser}</li>
<li>RunAs=App;AppId={AppId};TenantId=NotUsed;AppKey={ClientSecret}</li>
</ul> When used together with `KeyVaultClient`, the TenantId part of the connection string is not used, although `AzureServiceTokenProvider` throws an exception if it not provided. This is something that will [change in an upcoming version](https://github.com/Azure/azure-sdk-for-net/issues/4169) of `Microsoft.Azure.Services.AppAuthentication`. 

<h4 id="Azure-Managed-Service-Identity"><a href="#Azure-Managed-Service-Identity" class="headerlink" title="Azure Managed Service Identity"></a>Azure Managed Service Identity</h4><p>Azure has a service called Managed Service Identity (MSI) which essentially provides service principals which are maintained by Azure. MSI is supported in App Service, Functions and Virtual Machines. See <a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-service-identity/overview" target="_blank" rel="noopener">the official docs</a> for more details.</p>
<ul>
<li>RunAs=App;</li>
</ul> This is fantastic! No more hassling about generating certificates or rotating secrets.

<h4 id="Automatic-Mode"><a href="#Automatic-Mode" class="headerlink" title="Automatic Mode"></a>Automatic Mode</h4><p>If no connection string is provided, <code>AzureServiceTokenProvider</code> will try to resolve tokens in the following order:</p>
<ol>
<li>MSI</li>
<li>Visual Studio</li>
<li>Azure CLI</li>
</ol> If you use MSI in production and Visual Studio or Azure CLI for development, there is no need for any configuration. Yeah!


      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2018-05-09-Handle-Secrets-with-.NET-Core/" data-id="ck93ug7w1000idsyg02udeo56" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017-02-10-Creating-ARM-Service-Endpoints-from-Within-VSTS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017-02-10-Creating-ARM-Service-Endpoints-from-Within-VSTS/" class="article-date">
  <time datetime="2017-02-09T23:00:00.000Z" itemprop="datePublished">2017-02-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017-02-10-Creating-ARM-Service-Endpoints-from-Within-VSTS/">Creating ARM Service Endpoints From Within VSTS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>First, here is some background about what Visual Studio Team Services (VSTS) can do concerning Azure Resource Manager (ARM). </p>
<p>As you probably know, Releases in VSTS has the capability to deploy build artifacts to subscriptions in Azure. Releases are configured through a list of tasks that performs the actual work, such as for example creating infrastructure with ARM-templates, or web-deploying applications to App Services.</p>
<p>VSTS lets you store connection details to Azure Subscriptions in Service Endpoints for later reuse in release tasks.</p>
<p>There are many Service Endpoint types, but the one of interest regarding ARM is the Azure Resource Manager Service Endpoint. When you create a new ARM Endpoint you enter its name, select one your Azure subscriptions in a dropdown, and if you are lucky, VSTS will create the connection. I will explain the prerequisites to be ?lucky? below.</p>
<p><img src="/2017-02-10-Creating-ARM-Service-Endpoints-from-Within-VSTS/vsts-add-arm-endpoint.png" alt="Add ARM endpoint dialog in VSTS"></p>
<p>The connection is actually an Azure application which use its service principal in the Azure Active Directory (Azure AD) to access subscriptions.</p>
<p>If you cannot find the subscription you intend to deploy to in the drop down, or if VSTS fails to create the endpoint, you can attempt to create it manually, either by creating the application and service principal by hand in the Azure Portal, or through the PowerShell API. Here is a <a href="https://blogs.msdn.microsoft.com/visualstudioalm/2015/10/04/automating-azure-resource-group-deployment-using-a-service-principal-in-visual-studio-online-buildrelease-management" target="_blank" rel="noopener">blog post by Roopesh Nair</a> that explains the procedure in more detail. It links to a <a href="https://github.com/Microsoft/vsts-rm-documentation/blob/master/Azure/SPNCreation.ps1" target="_blank" rel="noopener">PowerShell script</a> that I have used on many occasions as a base when I had to set things up manually.</p>
<h2 id="Manual-or-Automatic-Creation"><a href="#Manual-or-Automatic-Creation" class="headerlink" title="Manual or Automatic Creation"></a>Manual or Automatic Creation</h2><p>As you might already know, ARM service endpoints can only be shared within the team project where they are created. Since it takes a few minutes to get through the manual steps, I think that creating ARM Endpoints manually is a real pain, especially if your company use many team projects. I find it more beneficial to spend time to configure the subscriptions so that each user can let VSTS create the endpoints automatically for them, right when they are needed.</p>
<h2 id="Automatic-ARM-Endpoint-Creation-Prerequisites"><a href="#Automatic-ARM-Endpoint-Creation-Prerequisites" class="headerlink" title="Automatic ARM Endpoint Creation Prerequisites"></a>Automatic ARM Endpoint Creation Prerequisites</h2><p>Here is a list of prerequisites that needs to be met to make VSTS able to create applications and grant subscription rights to their service principals. Some are more obvious than others.</p>
<ul>
<li>You must have an activated Azure Subscription (Duh!). </li>
<li>Each subscription belongs to an Azure AD, and the account that you use to log into VSTS with needs to be present there.</li>
<li>The account needs to be able to create an application in the Azure AD.</li>
<li>The account needs to have the <code>*/read</code> and <code>Microsoft.Authorization/*/Write</code> permissions in the subscription.</li>
</ul>
<h3 id="Creating-an-Azure-Subscription"><a href="#Creating-an-Azure-Subscription" class="headerlink" title="Creating an Azure Subscription"></a>Creating an Azure Subscription</h3><p>If you have a Visual Studio Subscription or a Windows Developer account, you can activate your subscription with free credits through <a href="https://my.visualstudio.com" target="_blank" rel="noopener">https://my.visualstudio.com</a>. If you intend to use the subscription for production, create a Pay-As-You-Go subscription, preferably as a free account to start with from <a href="https://azure.microsoft.com/en-us/free" target="_blank" rel="noopener">https://azure.microsoft.com/en-us/free</a>.</p>
<h3 id="Adding-an-account-from-another-Azure-AD"><a href="#Adding-an-account-from-another-Azure-AD" class="headerlink" title="Adding an account from another Azure AD"></a>Adding an account from another Azure AD</h3><p>Adding users to an Azure AD has become much easier in the new portal compared to how it was done in the old. Now you can add or invite users in the same dialog.</p>
<p>If you enter a user email that corresponds to the Azure AD domain, a new user will be created. If you enter an email belonging to another domain, an invitation will be sent out, and the account will be added as a guest. I find it convenient to assign users that I add to the correct groups right in the add dialog.</p>
<h3 id="Allowing-Creation-of-Applications-in-Azure-AD"><a href="#Allowing-Creation-of-Applications-in-Azure-AD" class="headerlink" title="Allowing Creation of Applications in Azure AD"></a>Allowing Creation of Applications in Azure AD</h3><p>There is a setting named <em>Users can register applications</em> which is found under <em>Azure Active Directory - User settings</em>. If set to Yes, non-administrator users are allowed to add applications to the Azure AD. If it is set to No, then your user accounts which is going to be able to add VSTS ARM Endpoints will have to be assigned to the Global administrator directory role. To my knowledge, it is not possible to add applications with any of the Limited administrator directory roles.</p>
<p>If your Azure AD administrator is not fond of letting people creating applications as they like, my best advice is that you create a new directory for subscriptions, and that you add the user accounts that might create ARM endpoints in that as guests.</p>
<p><img src="/2017-02-10-Creating-ARM-Service-Endpoints-from-Within-VSTS/vsts-azure-ad-permissions.png" alt="User permissions in Azure Active Directory"></p>
<p>Guests users gets special treatment in Azure AD, and have a setting named <em>Guest users permissions are limited</em> which needs to be set to No to make them able to add applications. If it is set to Yes, it will not matter if you even assign the Global administrator role to the guest account. If you need to use guest accounts, this setting needs to be set to No. Period.</p>
<h3 id="Assigning-the-User-Access-Administrator-Role"><a href="#Assigning-the-User-Access-Administrator-Role" class="headerlink" title="Assigning the User Access Administrator Role"></a>Assigning the User Access Administrator Role</h3><p>The application service principals VSTS creates to use to connect to subscriptions gets Contributor rights by default. Because of this, the user that creates the ARM endpoint needs to be allowed to assign permissions in the subscription.</p>
<p>There are two default subscription roles that have the required permissions to do this, one is the <a href="https://docs.microsoft.com/en-us/azure/active-directory/role-based-access-built-in-roles#owner" target="_blank" rel="noopener">Owner</a> role, and the other the <a href="https://docs.microsoft.com/en-us/azure/active-directory/role-based-access-built-in-roles#user-access-administrator" target="_blank" rel="noopener">User Access Administrator</a> role.</p>
<p>One way to archive this could be to assign the accounts as subscription co-administrators, which would grant them the Owner role. This would work, but gets tedious if you have many accounts that should be able to create ARM endpoints. What is easier is to grant the role you intend to use using a group, let?s say one named VSTS Endpoint Managers.</p>
<p><img src="/2017-02-10-Creating-ARM-Service-Endpoints-from-Within-VSTS/vsts-azure-subscription-permissions.png" alt="User permissions in Azure Subscription"></p>
<p>If you are really lucky, you have a colleague that already maintains a directory group that you can reuse.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2017-02-10-Creating-ARM-Service-Endpoints-from-Within-VSTS/" data-id="ck93ug7w2000kdsyg572jcw1g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-11-14-Implementing-Custom-Tasks-in-VSTS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016-11-14-Implementing-Custom-Tasks-in-VSTS/" class="article-date">
  <time datetime="2016-11-13T23:00:00.000Z" itemprop="datePublished">2016-11-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016-11-14-Implementing-Custom-Tasks-in-VSTS/">Implementing Custom Tasks in VSTS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I think that one of the strengths of the build and release system in Visual Studio Team Services (VSTS) is the large variety of tasks that is available. If you ever want a task that does something that the default tasks can’t do, chances are high that someone else has made a task for just that purpose already, and that it’s ready to be installed from the <a href="https://marketplace.visualstudio.com/" target="_blank" rel="noopener">Visual Studio Marketplace</a>.</p>
<p>But sometimes you might be out of luck, and you have to make the work yourself. What now?</p>
<h2 id="Create-Task-Groups"><a href="#Create-Task-Groups" class="headerlink" title="Create Task Groups"></a>Create Task Groups</h2><p>The easiest way to create a reusable task is to create a Task Group from an already configured tasks in a build or release definition. You create a task group by selecting one or many tasks, right clicking, and selecting <em>Create task group</em>.</p>
<p>Here is an example of a task that I’ve made that is made up of a single <a href="https://marketplace.visualstudio.com/items?itemName=petergroenewegen.PeterGroenewegen-Xpirit-Vsts-Build-InlinePowershell" target="_blank" rel="noopener">Azure PowerShell task</a>.</p>
<p><img src="/2016-11-14-Implementing-Custom-Tasks-in-VSTS/Create-Tasks-in-VSTS-Task-Group-1.png" alt="Implementing Custom Tasks in VSTS - Task Group 1"></p>
<p>All configuration variables, <em>the ones named like <code>$(abc)</code></em>, that are present in the tasks of a task group are put as input parameters of the task group, each with a configurable default value and description.</p>
<p><img src="/2016-11-14-Implementing-Custom-Tasks-in-VSTS/Create-Tasks-in-VSTS-Task-Group-2.png" alt="Implementing Custom Tasks in VSTS - Task Group 2"></p>
<p>Task groups are great because they are so easy to make, but have the drawback of only being available in the team project where they are created.</p>
<h2 id="Implementing-Custom-Tasks-in-VSTS"><a href="#Implementing-Custom-Tasks-in-VSTS" class="headerlink" title="Implementing Custom Tasks in VSTS"></a>Implementing Custom Tasks in VSTS</h2><p>If you intend to share your tasks between several team projects or even accounts, your best option is to implement a custom task. Tasks in VSTS are made up of a command executable and a task manifest. The executable can be either a full blown command line application, or a simple PowerShell script. The task manifest is a json-file that contains some metadata such as the task ID, a declaration of what the configuration GUI should contain, and how the executable is invoked.</p>
<p>Strangely, I have not been able to find any official documentation of how to fill in the task manifest json-file. But there is an <a href="https://github.com/Microsoft/vsts-task-lib/pull/146" target="_blank" rel="noopener">active pull request</a> with a <a href="https://github.com/AArnott/vsts-task-lib/blob/taskJsonSchema/tasks.schema.json" target="_blank" rel="noopener">schema</a> that may be useful if you ever wonder what to write. </p>
<p>An easy way to get started is to copy one of the <a href="https://github.com/Microsoft/vsts-tasks" target="_blank" rel="noopener">default tasks of VSTS</a>, and modify it to your needs. Just remember to generate a new ID for your custom task!</p>
<p>The <a href="https://github.com/Microsoft/vsts-task-lib/blob/master/README.md" target="_blank" rel="noopener">documentation of the VSTS DevOps Task SDK</a> encourages you to write scripts for either the agent’s Node or PowerShell3 handlers.</p>
<p>Look at Microsoft’s reference tasks for guidance:</p>
<ul>
<li><a href="https://github.com/Microsoft/vsts-tasks/blob/master/Tasks/MSBuild" target="_blank" rel="noopener">MSBuild</a></li>
<li><a href="https://github.com/Microsoft/vsts-tasks/blob/master/Tasks/VSBuild" target="_blank" rel="noopener">VSBuild</a></li>
<li><a href="https://github.com/Microsoft/vsts-tasks/tree/master/Tasks/ShellScript" target="_blank" rel="noopener">ShellScript</a></li>
<li><a href="https://github.com/Microsoft/vsts-tasks/tree/master/Tasks/Xcode" target="_blank" rel="noopener">XCode</a></li>
</ul>
<p>Or, if you want an old school PowerShell task without that much “SDK-noise” you can copy one of mine: </p>
<ul>
<li><a href="https://github.com/johanclasson/vso-agent-tasks/tree/master/DbUpMigration" target="_blank" rel="noopener">DbUpMigration</a></li>
</ul>
<p>I think you will find that making your own custom tasks is quite straight forward.</p>
<h3 id="Install-Custom-Tasks-With-tfx-cli"><a href="#Install-Custom-Tasks-With-tfx-cli" class="headerlink" title="Install Custom Tasks With tfx-cli"></a>Install Custom Tasks With tfx-cli</h3><p>One way to install a task is to use the <a href="https://github.com/Microsoft/tfs-cli" target="_blank" rel="noopener">TFS Cross Platform Command Line utility (tfx-cli)</a> in a Node.js command prompt:</p>
<ul>
<li><code>npm install -g tfx-cli</code> - <em>This installs the tfx-cli tool.</em></li>
<li><code>tfx login</code> - <em>The login is reused throughout the entire session.</em><ul>
<li>Enter collection url &gt; <code>https://yourname.visualstudio.com/DefaultCollection</code></li>
<li>Enter personal access token &gt; <code>2lqewmdba7theldpuoqn7zgs46bmz5c2ppkazlwvk2z2segsgqrq</code> - <em>This is obviously a bogus token… You can add tokens to access your account at <a href="https://yourname.visualstudio.com/_details/security/tokens" target="_blank" rel="noopener">https://yourname.visualstudio.com/_details/security/tokens</a>.</em> </li>
</ul>
</li>
<li><code>tfx build tasks upload --task-path c:\path-to-repo\MyCustomTask</code><ul>
<li><em>If you change your mind and do not want a task anymore, you can remove it with</em> <code>tfx build tasks delete --task-id b8df3d76-4ee4-45a9-a659-6ead63b536b4</code>, <em>where the Guid is easiest found in the task.json of your task.</em></li>
</ul>
</li>
</ul>
<p>If you make a change to a task that you have previously uploaded, you have to bump its version before you upload it again.</p>
<h3 id="Create-Team-Services-Extensions"><a href="#Create-Team-Services-Extensions" class="headerlink" title="Create Team Services Extensions"></a>Create Team Services Extensions</h3><p>Another way to install a custom task is to package it inside an Team Services extension. You can read in the <a href="https://www.visualstudio.com/en-gb/docs/integrate/extensions/publish/overview" target="_blank" rel="noopener">official documentation how to get started</a>, or just follow these steps.</p>
<p>If you do not have a publisher id already, head over to the <a href="http://aka.ms/vsmarketplace-manage" target="_blank" rel="noopener">Visual Studio Marketplace Publishing Portal</a> and create it in one of the Azure directories which are associated with your account.</p>
<p>Create an extension manifest-file with the name <code>vss-extension.json</code>, and with content like the following:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"manifestVersion"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"UniqueExtensionId"</span>, <span class="comment">//FIXME</span></span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Your extension name"</span>, <span class="comment">//FIXME</span></span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"1.2.3"</span>, <span class="comment">//FIXME</span></span><br><span class="line">    <span class="attr">"publisher"</span>: <span class="string">"yourpublisherid"</span>, <span class="comment">//FIXME</span></span><br><span class="line">    <span class="comment">//"galleryFlags": ["Public"],</span></span><br><span class="line">    <span class="attr">"targets"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"Microsoft.VisualStudio.Services"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"A brief description which will be shown in the marketplace tile."</span>, <span class="comment">//FIXME</span></span><br><span class="line">    <span class="attr">"categories"</span>: [</span><br><span class="line">        <span class="string">"Build and release"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"tags"</span>: [ <span class="comment">//FIXME</span></span><br><span class="line">        <span class="string">"some"</span>,</span><br><span class="line">        <span class="string">"tags"</span>,</span><br><span class="line">        <span class="string">"for"</span>,</span><br><span class="line">        <span class="string">"discoverability"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"content"</span>: &#123;</span><br><span class="line">        <span class="attr">"details"</span>: &#123;</span><br><span class="line">            <span class="attr">"path"</span>: <span class="string">"relativePathTo/README.md"</span> <span class="comment">//FIXME</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"license"</span>: &#123;</span><br><span class="line">            <span class="attr">"path"</span>: <span class="string">"relativePathToLicenseFile"</span> <span class="comment">//FIXME</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"links"</span>: &#123;</span><br><span class="line">        <span class="attr">"support"</span>: &#123;</span><br><span class="line">            <span class="attr">"uri"</span>: <span class="string">"https://some-uri.com"</span> <span class="comment">//FIXME</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"branding"</span>: &#123;</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"rgb(36, 43, 50)"</span>,</span><br><span class="line">        <span class="attr">"theme"</span>: <span class="string">"dark"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"icons"</span>: &#123;</span><br><span class="line">        <span class="attr">"default"</span>: <span class="string">"relativePathTo/extension-icon.png"</span> <span class="comment">//FIXME</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"files"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"path"</span>: <span class="string">"relativePathToTaskFolder"</span> <span class="comment">//FIXME</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"contributions"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"UniqueIdOfTask"</span>, <span class="comment">//FIXME</span></span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"ms.vss-distributed-task.task"</span>,</span><br><span class="line">            <span class="attr">"targets"</span>: [</span><br><span class="line">                <span class="string">"ms.vss-distributed-task.tasks"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"relativePathToTaskFolder"</span> <span class="comment">//FIXME</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then, run the command <code>tfx extension create</code> in a Node.js command prompt, and upload the generated .vsix-file in the publishing portal.</p>
<p><img src="/2016-11-14-Implementing-Custom-Tasks-in-VSTS/Create-Tasks-in-VSTS-Publishing-Portal.png" alt="Implementing Custom Tasks in VSTS - Publishing Portal"></p>
<p>Or if you prefer, you can use the command <code>tfx extension publish</code> instead, and supply your personal access token. </p>
<p>If the <code>&quot;galleryFlags&quot;: [&quot;Public&quot;]</code> setting is kept commented out, the extension will default to be a private extension, meaning that the extension will only be available in the collections you choose. Access to private extensions are managed through the publishing portal.</p>
<p>Once your extension is battle proven, be a good community member and make it public so that all can benefit from your work.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2016-11-14-Implementing-Custom-Tasks-in-VSTS/" data-id="ck93ug7w0000hdsyghhagd9fu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-09-02-Migrating-a-GitHub-Repository-to-VSTS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016-09-02-Migrating-a-GitHub-Repository-to-VSTS/" class="article-date">
  <time datetime="2016-09-01T22:00:00.000Z" itemprop="datePublished">2016-09-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016-09-02-Migrating-a-GitHub-Repository-to-VSTS/">Migrating a GitHub Repository to VSTS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Regarding migrations, I have previous experience with migrating on premise Team Foundation Servers (TFS) to Visual Studio Team Services (VSTS). Those times I used tools such as the <a href="http://opshub.com/products/opshub-visual-studio-migration-utility/" target="_blank" rel="noopener">OpsHub Visual Studio Migration Utility</a> for copying work items and <a href="https://github.com/git-tfs/git-tfs" target="_blank" rel="noopener">Git TFS</a> for migrating source code.</p>
<p>Yes, you are right. The OpsHub utility can migrate source code as well. But since I’m a fan of Git I thought that I could do the TFVC to Git conversion when I was about to move anyway.</p>
<p>But enough about TFS-to-VSTS migrations. This post is about how I was trying to figure out how to approach migrating a GitHub repository to VSTS. This time, the problem was not about source code. VSTS has full support for Git, and pushing a Git repository to another remote is trivial. Here is a <a href="http://www.almguide.com/2016/02/10-steps-to-move-a-git-repo-from-github-to-visual-studio-team-services" target="_blank" rel="noopener">random blog post</a> (by Esteban Garcia) about the procedure.</p>
<h2 id="The-Problem-at-Hand"><a href="#The-Problem-at-Hand" class="headerlink" title="The Problem at Hand"></a>The Problem at Hand</h2><p>What I had to come up with was how to migrate Github Issues and their associated Milestones. The repository I was migrating had not done any Pull Requests, so I could disregard that type of entity completely.</p>
<p>When I googled around for solutions I found several attempts of using the <a href="https://developer.github.com/v3/" target="_blank" rel="noopener">GitHub REST API</a> to export issues into a CSV-format. In theory, I could use used the Excel TFS plugin to import these CSV-issues into VSTS… But, none of the scripts that I found actually worked the way that I wanted. Not even close.</p>
<p>So, that left me with the option of doing my own solution. Luckily, that turned out to be a good thing. The result went just the way I wanted it to be.</p>
<p><img src="/2016-09-02-Migrating-a-GitHub-Repository-to-VSTS/GitHubToVSTS.png" alt="Migrating a GitHub Repository to VSTS"></p>
<h2 id="Migrating-GitHub-Issues-to-VSTS"><a href="#Migrating-GitHub-Issues-to-VSTS" class="headerlink" title="Migrating GitHub Issues to VSTS"></a>Migrating GitHub Issues to VSTS</h2><p>The grand master plan was to use the GitHub REST API to get the information I needed, and to create iterations and work items through the VSTS REST API. To summarize, milestones were to be converted into iterations, and issues into work items.</p>
<h3 id="Extracting-Information-from-GitHub"><a href="#Extracting-Information-from-GitHub" class="headerlink" title="Extracting Information from GitHub"></a>Extracting Information from GitHub</h3><p>I started out by making a GET request to list all <a href="https://developer.github.com/v3/issues/#list-issues-for-a-repository" target="_blank" rel="noopener">issues for the GitHub repository</a>, but quickly found out that the result was paginated, and I only got the first 30 or so… I had to repeatedly make requests for the next page, whose URL were hiding behind a <a href="https://tools.ietf.org/html/rfc5988#page-6" target="_blank" rel="noopener">Link-header</a> in the response. It actually took me some time to figure this out, and it was not until I finally read the documentation that I discovered it. Note to self, <a href="https://en.wikipedia.org/wiki/RTFM" target="_blank" rel="noopener">RTFM</a>…</p>
<p>Then I noticed that most descriptions and comments where formatted in markdown. VSTS need to have its content in bare html, so I needed a way to convert the formatting somehow. Lucky me, the GitHub API has <a href="https://developer.github.com/v3/markdown/#render-a-markdown-document-in-raw-mode" target="_blank" rel="noopener">an endpoint just for that purpose</a>!</p>
<p>I think its raw <code>text/plain</code> method is really convenient. If I ever find myself in need for markdown conversion once more, I will definitely consider to use the GitHub API again.</p>
<h3 id="Creating-Work-Items-and-Iterations-in-VSTS"><a href="#Creating-Work-Items-and-Iterations-in-VSTS" class="headerlink" title="Creating Work Items and Iterations in VSTS"></a>Creating Work Items and Iterations in VSTS</h3><p>Now it was time to create some entities in VSTS, and I started with the iterations. The GitHub milestones have both title and description. Iterations just have title, so the description hade to be lost in the migration. Milestones have end date (due date, really) but lacks start date. My approach was that if a milestone had a due date set, I used the date that the milestone was created as start date for the iteration.</p>
<p>The hardest part was to find the name of the endpoint for iteration creation in the VSTS REST API. After some extensive research, I discovered that areas and iterations are called “<a href="https://www.visualstudio.com/en-us/docs/integrate/api/wit/classification-nodes#create-an-iteration" target="_blank" rel="noopener">classification nodes</a>“ in REST API-language.</p>
<p>As I tested out creating iterations, I was reminded that <a href="https://www.visualstudio.com/docs/reference/naming-restrictions#area-path-and-iteration-path" target="_blank" rel="noopener">some characters are not allowed in their names</a>. </p>
<p><em>I find that these restrictions are quite interesting. I can imagine why some characters are not allowed, but there are also naming restrictions. Like for example that an iteration is not allowed to be named COM1 or AUX. How on earth could the backend software be written, if the name of an entity would risk the entity to be mixed up with some random parallel port?</em></p>
<p>Creating work items was a real breeze. One just compose <a href="https://www.visualstudio.com/en-us/docs/integrate/api/wit/work-items#with-a-work-item-link" target="_blank" rel="noopener">a list of instructions of how the fields and states of the work item should be</a>. The only thing that was a bit troublesome was that if I sent instructions to create several comments on a work item, only the last was actually entered. My solution to that problem was to first create the work item without comments, and then update it once for each comment that needed to be added.</p>
<p>A very nice feature of the endpoints for creating and updating work items is <a href="https://www.visualstudio.com/en-us/docs/integrate/api/wit/work-items#make-an-update-bypassing-rules" target="_blank" rel="noopener">the bypassRules query parameter</a>. It made it possible for me to both create and update work items while having the original GitHub usernames show up in their history.</p>
<h2 id="Show-Me-Some-Code-Already"><a href="#Show-Me-Some-Code-Already" class="headerlink" title="Show Me Some Code Already!"></a>Show Me Some Code Already!</h2><p>The script is too long to be included in this blog post (Duh!), but here is <a href="https://github.com/johanclasson/MigrationTools" target="_blank" rel="noopener">a link to a GitHub repository of mine</a> where you can get it, and also read more about the details of what information gets copied.</p>
<h3 id="Be-Weary-of-Gotchas"><a href="#Be-Weary-of-Gotchas" class="headerlink" title="Be Weary of Gotchas"></a>Be Weary of Gotchas</h3><ul>
<li>You need to be a member of the VSTS “Project Collection Service Accounts” group to be allowed to use the bypassRules query parameter.</li>
<li>I used basic authentication to login on GitHub. If you have an account with activated two factor authentication that method will not work for you.</li>
<li>Only milestones that have issues relating to them are migrated. Empty milestones are not included.</li>
</ul>
<h2 id="Lessons-learned"><a href="#Lessons-learned" class="headerlink" title="Lessons learned"></a>Lessons learned</h2><ul>
<li>Read the documentation.</li>
<li>Writing custom migration logic is not as hard using REST APIs as with the (dreaded, and outdated) <a href="https://tfsintegration.codeplex.com" target="_blank" rel="noopener">TFS Integration Platform</a> toolkit.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2016-09-02-Migrating-a-GitHub-Repository-to-VSTS/" data-id="ck93ug7vz000gdsyg34mze4df" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-03-25-Automatic-Testing-with-an-In-memory-Database-and-EF7" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016-03-25-Automatic-Testing-with-an-In-memory-Database-and-EF7/" class="article-date">
  <time datetime="2016-03-24T23:00:00.000Z" itemprop="datePublished">2016-03-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016-03-25-Automatic-Testing-with-an-In-memory-Database-and-EF7/">Automatic Testing With an In-Memory Database and EF7</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If you have ever written automatic tests that runs against a real database, you might have noticed that the tests ran quite slow. To get around this problem, we instead target some kind of fake database which is kept in-memory.</p>
<p>To my knowledge, you could have done this in two ways while working with Entity Framework (EF).</p>
<p>One way has been to hide the DbContext behind some kind of abstraction. This makes it possible to replace the DbContext with simple list-objects when running an automatic test. For example the <a href="https://effort.codeplex.com/" target="_blank" rel="noopener">Effort project</a>, or the more simplistic <a href="http://blog.nethouse.se/2015/05/02/nethouse-unit-of-work-pattern/" target="_blank" rel="noopener">Nethouse UoW Pattern</a> use this approach.</p>
<p>Another way has been to use a SQLite in-memory database, but I have never seen a solution with working code first migrations in EF. At least not until now.</p>
<h2 id="New-Capabilities-of-Entity-Framework-7"><a href="#New-Capabilities-of-Entity-Framework-7" class="headerlink" title="New Capabilities of Entity Framework 7"></a>New Capabilities of Entity Framework 7</h2><p>With the coming arrival of EF7, code first migrations are finally supported with SQLite. Well? As long as you keep within the <a href="https://docs.efproject.net/en/latest/providers/sqlite/limitations.html" target="_blank" rel="noopener">technical limitations of SQLite</a> that is.</p>
<p>Another nice feature is the brand new InMemory database. Microsoft designed it to be a <a href="https://docs.efproject.net/en/latest/miscellaneous/testing.html" target="_blank" rel="noopener">general purpose in-memory test replacement</a>. Since it is not a relational database, things like migrations or referential integrity constraints will not work. </p>
<h2 id="Target-an-In-memory-Database"><a href="#Target-an-In-memory-Database" class="headerlink" title="Target an In-memory Database"></a>Target an In-memory Database</h2><p>It’s relatively straight forward how to configure a DbContext derivate to target either SQLite or InMemory. But the way you configure it in your production code might prevent you do that in your tests. In the case of the .NET framework version of EF, the usual way to configure the DbContext is by overriding a method inside the class.</p>
<p>So how can you tackle the problem of how to configure the DbContext to use a test database? For instance, you can’t simply solve this by setting up a configurable connection string.</p>
<p>The InMemory database is a different sort of provider and has to be activated by code. The SQLite in-memory could actually work with just an updated connection string, in theory that is. But a SQLite in-memory database resets each time the connection to it is closed, and the DbContext open and close the connection a lot.</p>
<p>One could of course do this by adding extra code to the DbContext derivate, where one could inject configuration code to target the test database. But as always, isn’t it a bad practice to keep test code in the production code?</p>
<p>Luckily, in EF7 it’s possible to configure the DbContext when adding Entity Framework to a <code>ServiceCollection</code> instance.  This configuration is rather verbose, but can without much effort be reused it in all your tests. This is my approach:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Data.Common;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Data.Entity;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Data.Sqlite;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">EF.TestUtils</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">TestContextFactory</span> : <span class="title">IDisposable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> IDisposable _connection;</span><br><span class="line">        <span class="keyword">private</span> IDisposable _scope;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> _index;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">object</span> Locker = <span class="keyword">new</span> <span class="keyword">object</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> TContext CreateInMemoryDatabase&lt;TContext&gt;() <span class="keyword">where</span> TContext : DbContext</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> serviceCollection = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">            serviceCollection.AddEntityFramework().AddInMemoryDatabase()</span><br><span class="line">                .AddDbContext&lt;TContext&gt;(c =&gt; c.UseInMemoryDatabase());</span><br><span class="line">            <span class="keyword">var</span> serviceProvider = serviceCollection.BuildServiceProvider();</span><br><span class="line">            <span class="keyword">var</span> scope = serviceProvider.GetRequiredService&lt;IServiceScopeFactory&gt;().CreateScope();</span><br><span class="line">            _scope = scope;</span><br><span class="line">            <span class="keyword">return</span> scope.ServiceProvider.GetService&lt;TContext&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> TContext CreateInMemorySqlite&lt;TContext&gt;(<span class="keyword">bool</span> migrate = <span class="literal">true</span>) <span class="keyword">where</span> TContext : DbContext</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> connectionString = CreateSqliteSharedInMemoryConnectionString();</span><br><span class="line">            DbConnection connection = OpenConnectionToKeepInMemoryDbUntilDispose(connectionString);</span><br><span class="line">            <span class="keyword">var</span> dbContext = CreateSqliteDbContext&lt;TContext&gt;(connection);</span><br><span class="line">            <span class="keyword">if</span> (migrate)</span><br><span class="line">                dbContext.Database.Migrate();</span><br><span class="line">            <span class="keyword">return</span> dbContext;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">CreateSqliteSharedInMemoryConnectionString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> name = GetUniqueName();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">$"Data Source=<span class="subst">&#123;name&#125;</span>;Mode=Memory;Cache=Shared"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetUniqueName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (Locker)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">$"testdb<span class="subst">&#123;++_index&#125;</span>.db"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> DbConnection <span class="title">OpenConnectionToKeepInMemoryDbUntilDispose</span>(<span class="params"><span class="keyword">string</span> connectionString</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> connection = <span class="keyword">new</span> SqliteConnection(connectionString);</span><br><span class="line">            connection.Open();</span><br><span class="line">            _connection = connection;</span><br><span class="line">            <span class="keyword">return</span> connection;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> TContext CreateSqliteDbContext&lt;TContext&gt;(DbConnection connection) <span class="keyword">where</span> TContext : DbContext</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> serviceCollection = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">            serviceCollection.AddEntityFramework().AddSqlite()</span><br><span class="line">                .AddDbContext&lt;TContext&gt;(c =&gt; c.UseSqlite(connection));</span><br><span class="line">            IServiceProvider serviceProvider = serviceCollection.BuildServiceProvider();</span><br><span class="line">            <span class="keyword">var</span> scope = serviceProvider.GetRequiredService&lt;IServiceScopeFactory&gt;().CreateScope();</span><br><span class="line">            _scope = scope;</span><br><span class="line">            <span class="keyword">return</span> scope.ServiceProvider.GetService&lt;TContext&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _connection?.Dispose();</span><br><span class="line">            _scope?.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note that my utility class references types from both the <code>EntityFramework.InMemory</code> and <code>EntityFramework.Sqlite</code> NuGet packages. If you have a problem with that you can split up the class, but I find it rather convenient to have both capabilities in a utils-package that I reuse in all my test projects. And since we are dealing with test-code here, I do not think it matters that much if a NuGet-package to much is brought in.</p>
<p>To make it possible to switch out the DbContext derivative instance when running an automatic test, make sure you inject it in your production code instead of instantiating it there.</p>
<p>Creating an instance of the DbContext with test configuration can be done similar to this.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> factory = <span class="keyword">new</span> TestContextFactory())</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> context = factory.CreateInMemorySqlite&lt;MyContext&gt;(migrate: <span class="literal">true</span>))</span><br><span class="line">&#123;</span><br><span class="line">    RunScenario(context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Or...</span></span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> factory = <span class="keyword">new</span> TestContextFactory())</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> context = factory.CreateInMemoryDatabase&lt;MyContext&gt;())</span><br><span class="line">&#123;</span><br><span class="line">    RunScenario(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Avoid-Configuring-Two-Database-Providers-During-Test-Runs"><a href="#Avoid-Configuring-Two-Database-Providers-During-Test-Runs" class="headerlink" title="Avoid Configuring Two Database Providers During Test Runs"></a>Avoid Configuring Two Database Providers During Test Runs</h2><p>If you use the .NET framework version of EF, and override the <code>OnConfiguring</code> method to configure the DbContext, that method will be called even if you inject the configuratoin with help of the <code>TestContextFactory</code>. Therefore it’s a good practice to prevent cofiguration of multiple database providers in the following way.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">MyContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnConfiguring</span>(<span class="params">DbContextOptionsBuilder optionsBuilder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!optionsBuilder.IsConfigured) <span class="comment">// This prevents multiple configurations</span></span><br><span class="line">        &#123;</span><br><span class="line">            optionsBuilder.UseSqlite(<span class="string">@"Data Source=c:\temp\mydatabase.sqlite;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Entity-Framework-Code-First-Migrations"><a href="#Entity-Framework-Code-First-Migrations" class="headerlink" title="Entity Framework Code First Migrations"></a>Entity Framework Code First Migrations</h2><p>Note that you do not need to run migrations when using an InMemory database. In fact, it does not even support migrations at all. If you want to test migrations, you have to use a real database such as SQLite.</p>
<p>Migrations are very specific to the type of database that they are written for. This probably makes it a bad idea to test SQL Server migrations on a SQLite database. EF migrations will most likely contain raw scripts when data is affected by the requested change. Remember that the DbContext does not work in a migration? Therefore, you better use the same database technology in your migration tests as you intend to use in your production code.</p>
<p>When you think about what database to choose, in my opinion, you should definitely consider to use SQLite. Not only because its free of charge, but also because you will have a better testing experience with it. Not all apps need the extra horsepower that SQL server brings.</p>
<p>A great thing with EF is that your workflow will be quite similar, whatever database you happen to choose. Now go and test that database logic!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2016-03-25-Automatic-Testing-with-an-In-memory-Database-and-EF7/" data-id="ck93ug7vz000fdsyg9dtucm5w" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-03-14-Database-Migration-with-DbUp-and-VSTS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016-03-14-Database-Migration-with-DbUp-and-VSTS/" class="article-date">
  <time datetime="2016-03-13T23:00:00.000Z" itemprop="datePublished">2016-03-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016-03-14-Database-Migration-with-DbUp-and-VSTS/">Database Migration With DbUp and VSTS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>All too often I find myself in projects where there is no efficient strategy around updating databases. Databases should be able to be migrated to the latest version without too much effort. If it’s too hard, developers will start sharing databases, or even worse, use a test environment database directly. </p>
<p>If you usually do migrations by comparing the schema of two databases, now is an opportunity for you to do something better. Besides schema and security, a database also consists of data, and data is troublesome. Large tables takes both time and resources to alter. A tool simply cannot generate resource efficient migrations, or for example figure out where the data in that dropped column should go instead.</p>
<p>Therefore you will always need a process or another tool to run transitional scripts beside the schema comparer. If you instead focus on the transitional script runner and have it logging which scripts that has been run to some persistent storage, you can use that log as a simple means to version your database. </p>
<p>Also, do not forget to include configuration data, or sample data for test and development, in your migration process.</p>
<h2 id="Run-Migrations-with-DbUp-and-VSTS-or-TFS-2015"><a href="#Run-Migrations-with-DbUp-and-VSTS-or-TFS-2015" class="headerlink" title="Run Migrations with DbUp and VSTS (or TFS 2015)"></a>Run Migrations with DbUp and VSTS (or TFS 2015)</h2><p>A favorite transitional script runner of mine have long been <a href="https://dbup.github.io/" target="_blank" rel="noopener">DbUp</a>. </p>
<blockquote>
<p>DbUp is a .NET library that helps you to deploy changes to SQL Server databases. It tracks which SQL scripts have been run already, and runs the change scripts that are needed to get your database up to date.</p>
<p>– <a href="http://dbup.readthedocs.org/en/latest/" target="_blank" rel="noopener">DbUp Documentation</a>.</p>
</blockquote>
<p>One way that you can get started with DbUp is by importing its NuGet-package in a .NET console project. But I prefer to invoke it through PowerShell. That way nothing needs to be compiled, and as long as you have access to your migration scripts you are good to go. The PowerShell way also makes a good match for deployment scenarios with Octopus Deploy or Release Management.</p>
<p>I have made a <a href="https://github.com/johanclasson/vso-agent-tasks#update-database-with-dbup" target="_blank" rel="noopener">VSTS Build and Release Task</a> for this purpose. But, if you would like to run DbUp elsewhere, the important part of the task is this <a href="https://github.com/johanclasson/vso-agent-tasks/blob/master/DbUpMigration/task/Update-DatabaseWithDbUp.ps1" target="_blank" rel="noopener">PowerShell script</a>.</p>
<h2 id="Run-Your-Tools-Often"><a href="#Run-Your-Tools-Often" class="headerlink" title="Run Your Tools Often"></a>Run Your Tools Often</h2><p>As with all deployment tools, you should run them often. The more you run them the higher the probability gets that you will have found all mistakes before deployment is made to the production environment. This does not only mean that the same tool should be run in your CI builds, but also that each developer should use it to set up their own personal database. Never underestimate the value of dogfooding your deployment tools!</p>
<h2 id="Non-transitional-Changes"><a href="#Non-transitional-Changes" class="headerlink" title="Non-transitional Changes"></a>Non-transitional Changes</h2><p>All database objects do not need to be changed transitionally like tables. For example regarding stored procedures and security objects, a more pragmatic approach is to keep a set of idempotent scripts that are run on each deploy. This is supported by the PowerShell script above with the <em>Journal</em> parameter. </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2016-03-14-Database-Migration-with-DbUp-and-VSTS/" data-id="ck93ug7vy000edsyg4i2f2psi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-02-25-Pay-151-SEK-Get-2400-SEK-Back-as-Azure-Credits" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016-02-25-Pay-151-SEK-Get-2400-SEK-Back-as-Azure-Credits/" class="article-date">
  <time datetime="2016-02-24T23:00:00.000Z" itemprop="datePublished">2016-02-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016-02-25-Pay-151-SEK-Get-2400-SEK-Back-as-Azure-Credits/">Pay 151 SEK - Get 2400 SEK Back as Azure Credits (Microsoft Developer Program Benefit)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I just recently got an email from Microsoft where they advertised one of their latest Azure drives. They now give monthly credits to all who got a Windows- and/or Windows Phone developer account.</p>
<p>If you have not got one already, my guess is that you will receive this benefit as well when you register. Just head to <a href="https://dev.windows.com/" target="_blank" rel="noopener">Windows Dev Center</a> and sign up. To get an account you have to pay a minor fee, equivalent to 151 SEK.</p>
<h2 id="Develper-Program-Benefit"><a href="#Develper-Program-Benefit" class="headerlink" title="Develper Program Benefit"></a>Develper Program Benefit</h2><p>To collect your monthly credits enter <a href="https://www.visualstudio.com/en-us/products/visual-studio-dev-essentials-vs.aspx" target="_blank" rel="noopener">Visual Studio Dev Essentials</a>, and follow the link <em>Access your benefits</em>. Then look for the Developer Program Benefit tile.</p>
<p><img src="/2016-02-25-Pay-151-SEK-Get-2400-SEK-Back-as-Azure-Credits/Tile.png" alt="Microsoft Developer Program Benefit tile"></p>
<p>(Don’t forget the 6 month free Pluralsight subscription either!)</p>
<p>Activating the Developer Program Benefit creates a new Azure subscription for you.</p>
<p><img src="/2016-02-25-Pay-151-SEK-Get-2400-SEK-Back-as-Azure-Credits/Result.png" alt="Monthly Microsoft Developer Program Benefit"></p>
<p>Personally, I will use this for making backups of my NAS to Azure Blob Storage. What will you do for your “free” credits? You can get a lot of fun for 200 SEK worth every month. Pay 151 SEK, and get 2400 back is IMHO a really good deal!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2016-02-25-Pay-151-SEK-Get-2400-SEK-Back-as-Azure-Credits/" data-id="ck93wim3i0000b4ygeme179jy" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019-05-31-Release-Notes-with-Azure-DevOps/">Release Notes With Azure DevOps</a>
          </li>
        
          <li>
            <a href="/2018-11-29-Asynchronously-Wait-for-Task-to-Complete-with-Timeout/">Asynchronously Wait for Task to Complete With Timeout</a>
          </li>
        
          <li>
            <a href="/2018-06-29-Get-started-with-invisible-reCAPTCHA/">Get Started With Invisible reCAPTCHA</a>
          </li>
        
          <li>
            <a href="/2018-05-09-Handle-Secrets-with-.NET-Core/">Handle Secrets With .NET Core</a>
          </li>
        
          <li>
            <a href="/2017-02-10-Creating-ARM-Service-Endpoints-from-Within-VSTS/">Creating ARM Service Endpoints From Within VSTS</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Johan Classon<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>