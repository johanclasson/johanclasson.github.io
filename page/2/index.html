<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-163865120-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>Johan Classon Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Johan Classon Blog">
<meta property="og:url" content="https://blog.classon.eu/page/2/index.html">
<meta property="og:site_name" content="Johan Classon Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Johan Classon">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@johan_classon">
  
    <link rel="alternate" href="/atom.xml" title="Johan Classon Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Johan Classon Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.classon.eu"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2016-02-22-How-to-use-Moq-with-.NET-Core-Apps" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016-02-22-How-to-use-Moq-with-.NET-Core-Apps/" class="article-date">
  <time datetime="2016-02-21T23:00:00.000Z" itemprop="datePublished">2016-02-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016-02-22-How-to-use-Moq-with-.NET-Core-Apps/">How to Use Moq With .NET Core Apps</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Writing <a href="http://research.microsoft.com/apps/mobile/news.aspx?post=%2Fen-us%2Fnews%2Ffeatures%2Fnagappan-100609.aspx" target="_blank" rel="noopener">automatic tests is crucial if you care about producing code with good quality</a>. And why shouldn’t you! Yes, writing tests takes time, but the effort will soon be repaid. At least if the code is going to be around for a while. Have you ever been in a project where no one dares to refactor code since it is without coverage? Come on, be a <a href="http://blog.cleancoder.com/uncle-bob/2015/11/18/TheProgrammersOath.html" target="_blank" rel="noopener">Software Professional</a>!</p>
<p>Enough said about that…</p>
<p>When I test my code I make use of a suite of tools to make the work as easy as possible. There are many tools out there, and at least I am not interested in learning to use more of them than I have to. All devs have their favorite tools for testing, and one of mine is <a href="https://github.com/moq/moq4" target="_blank" rel="noopener">Moq</a>. When a new framework or platform is released I would very much still be able to instrument the mocking framework the way I am used to. </p>
<p>If you try to use Moq through the official NuGet feed in an ASP.NET Core- or Universal Windows Platform (UWP) project you will find yourself in trouble. Some of the error messages you might see are:</p>
<ul>
<li><code>The dependency Moq 4.2.1510.2205 in project MyWebApplication does not support framework DNXCore,Version=v5.0</code></li>
<li><code>Moq 4.2.1510.2205 is not compatible with UAP,Version=v10.0</code>.</li>
</ul>
<p>Moq does simply not support .NET Core yet. Now, what to do?</p>
<h2 id="The-ASP-NET-Devs-at-Microsoft-to-the-Rescue"><a href="#The-ASP-NET-Devs-at-Microsoft-to-the-Rescue" class="headerlink" title="The ASP .NET Devs at Microsoft to the Rescue"></a>The ASP .NET Devs at Microsoft to the Rescue</h2><p>I have <a href="http://stackoverflow.com/questions/27918305/mocking-framework-for-asp-net-core-5-0/34933925#34933925" target="_blank" rel="noopener">come across</a> a <a href="https://github.com/aspnet/moq4" target="_blank" rel="noopener">fork of the Moq project</a> which luckily has added support for .NET Core. What is even better, there is a public NuGet feed at <code>https://www.myget.org/F/aspnetcidev/api/v3/index.json</code> where packages from that project are available. </p>
<p>One way to use a nonstandard NuGet package source is to create a NuGet.Config-file in the root of your solution folder looking something like this:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packageSources</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">"AspNetVNext"</span> <span class="attr">value</span>=<span class="string">"https://www.myget.org/F/aspnetcidev/api/v3/index.json"</span> /&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">packageSources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Or you can add the AspNetVNext source-tag in your user profile NuGet file at <code>%AppData%\NuGet\NuGet.Config</code>.</p>
<p>Note that the Moq package with .NET Core support is in preview. To reference it, add <code>&quot;moq.netcore&quot;: &quot;4.4.0-beta8&quot;</code> as a dependency in your <code>project.json</code>-file.</p>
<p><em>Thank you Microsoft Devs for allowing me to use Moq on the .NET Core framework!</em></p>
<h2 id="xUnit-and-the-Universal-Windows-Platform"><a href="#xUnit-and-the-Universal-Windows-Platform" class="headerlink" title="xUnit and the Universal Windows Platform"></a>xUnit and the Universal Windows Platform</h2><p>Another tool which I’m fond of is xUnit. To get xUnit to work with UWP you have to add it to a Unit Test App project. Adding it to a class library the way you might be used to does not work. The procedure is described in detail in the <a href="https://xunit.github.io/docs/getting-started-uwp.html" target="_blank" rel="noopener">xUnit documentation</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2016-02-22-How-to-use-Moq-with-.NET-Core-Apps/" data-id="ck93ug7vy000cdsyg1iry8g6f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-12-14-Automatically-Stop-Azure-Resource-Manager-VMs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015-12-14-Automatically-Stop-Azure-Resource-Manager-VMs/" class="article-date">
  <time datetime="2015-12-13T23:00:00.000Z" itemprop="datePublished">2015-12-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015-12-14-Automatically-Stop-Azure-Resource-Manager-VMs/">Automatically Stop Azure Resource Manager VMs</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>A question that I get fairly often is how to automatically stop virtual machines in Azure so that they get deallocated and practically does not cost anything. There are many ways to do this, and in this blog post, I am going to describe how to do it with Azure Automation Runbooks.</p>
<p>The virtual machines that are best suited to automate starting and stopping of, are the ones that does not need to give a response quickly. Test environments, machines with background worker roles, and build infrastructure are some good examples. Production web servers are not, at least not by automation runbooks. Im sure you get that it is wiser to rely on the autoscaling load balancing for those servers instead.</p>
<h2 id="Different-Approaches-to-Starting-Runbooks"><a href="#Different-Approaches-to-Starting-Runbooks" class="headerlink" title="Different Approaches to Starting Runbooks"></a>Different Approaches to Starting Runbooks</h2><p>Azure has a feature called Automation that can contain runbooks. A runbook is, simply put, a PowerShell script with some extra hosting features such as logging and a platform to run on. Runbooks can be started by schedule, or through a HTTP Post webhook, or if you want to complicate things, by a PowerShell command in another runbook.</p>
<p>When I first started automating starting and stopping Azure resources I used daily repeating schedules because of their simplicity. But that approach has its limitations. The biggest one is that it is hard to predict when a machine is actually needed. For example, if you schedule your virtual machines to be running monday to friday from say 08:00 to 18:00 you will find that the schedule needs to be tinkered with more often that you think. Vacations, illness, and conferences are are just some occasions where you might have to disable your schedules to save some extra credits.</p>
<p>The better way would be to start your virtual machines first when they are really needed. And then when they are no longer used, to stop them as soon as you know this. This type of automation can be archived by starting the runbooks primarily by webhooks, and only use repeated schedules as a safety if your webhook automation would happen to fail.</p>
<p>The possibilities to invoke rest methods are endless. Make your phone call a start VMs webook when it connects to your work WIFI. Make traffic on a web server call a webhook to postpone your stop VMs runbook schedule. You can surely think of other interesting ways.</p>
<h3 id="Delayed-Webhook-Runbook-Startup"><a href="#Delayed-Webhook-Runbook-Startup" class="headerlink" title="Delayed Webhook Runbook Startup"></a>Delayed Webhook Runbook Startup</h3><p>Schedules does not need to be repeated. In fact, a schedule which is configured to start a runbook only once is a great tool to delay the startup of that runbook after a webhook has been used.</p>
<h2 id="How-to-Get-Started"><a href="#How-to-Get-Started" class="headerlink" title="How to Get Started"></a>How to Get Started</h2><p>In the Azure portal, you find the Automation account under <em>New - Management</em>.</p>
<p><img src="/2015-12-14-Automatically-Stop-Azure-Resource-Manager-VMs/Create-automation-account.png" alt="Create Automation Account"></p>
<p>To make it possible to reuse PowerShell scripts between automation accounts, It is convenient to link your automation account to a GitHub repository where you can store all your runbook scripts. You can do this by clicking the <em>Set Up Source Control</em> tile, entering your repository details, and then clicking on Sync. This will add a runbook for every PowerShell script, each with the authoring status <em>New</em>. To be able to run one of the imported runbooks, you have to publish it. You can do that by clicking it, then <em>Edit - Publish</em>.</p>
<p><img src="/2015-12-14-Automatically-Stop-Azure-Resource-Manager-VMs/Automation-account.png" alt="Automation Account"></p>
<p>Each automation account has a number of modules by default, which can be found under <em>Assets - Modules</em>. If your PowerShell scripts depend on another module, you can upload it there.</p>
<p>To make it possible to start a runbook, you click it and then click either <em>Schedule</em> or <em>Webhook</em>. You can then configure any parameters that your PowerShell script needs in that schedule or webhook instance.</p>
<h2 id="A-Practical-Example"><a href="#A-Practical-Example" class="headerlink" title="A Practical Example"></a>A Practical Example</h2><p>In my Visual Studio Team Services (VSTS) account, I have a project called Akkomation which I use to build a home automation software that I store the <a href="https://github.com/johanclasson/Akkomation" target="_blank" rel="noopener">source code for on GitHub</a> (more about that in a later blog post).</p>
<p>Each time I check in, a build is triggered in VSTS which runs the tests, and performs analysis on a SonarQube server which I host in Azure.</p>
<p>Since I am the only contributor to the project code is pushed rather seldom, so it does not make sense to have the SonarQube server up and running 24/7. When I do push, I am often interested to see analysis results such as code coverage and code analysis issues.</p>
<h3 id="Build-Workflow"><a href="#Build-Workflow" class="headerlink" title="Build Workflow"></a>Build Workflow</h3><p>The build workflow is to first check if the SonarQube server is running, and if not, start it up with a webhook. VSTS includes an <em>Azure Resource Group Deployment</em> task which can start Azure Resource Manager virtual machines. A benefit of starting the SonarQube server with a webhook is that the build can continue while it is booting up.</p>
<p>Just before the SonarQube analysis begins, the build waits for the service endpoint to come up. Then when the analysis is complete, an runbook which stops the virtual machine is scheduled to start three hours later.</p>
<p>If another build is triggered before then, the SonarQube server is reused, and the stop runbook is rescheduled to run three hours after that the second build completes.</p>
<p><img src="/2015-12-14-Automatically-Stop-Azure-Resource-Manager-VMs/Build-workflow.png" alt="Akkomation Build Workflow"></p>
<p>This workflow use two custom tasks:</p>
<ul>
<li><em>Inline PowerShell</em>, which runs a PowerShell script that is entered in the task instead of running a ps1-file as the normal PowerShell task does. I do not like to check in files in a repo just to make a build workflow possible. At least not in a small project like this one.</li>
<li><em>Invoke Rest Method</em>, which calls a rest method. Surprise! What it also does is that it tries to invoke it once every ten seconds until it succeeds, up until a configurable timeout. </li>
</ul>
<p>You can download both tasks at my <a href="https://github.com/johanclasson/vso-agent-tasks" target="_blank" rel="noopener">vso-agent-tasks repository</a> on GitHub.</p>
<p>The PowerShell script of the <em>Start SonarQube VM if Not Running</em> task is a simple one. </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Write-Output</span> <span class="string">"Resetting Stop SonarQube VM runbook schedule."</span></span><br><span class="line"><span class="built_in">Invoke-RestMethod</span> <span class="literal">-Method</span> Post <span class="literal">-Uri</span> <span class="string">"https://s2events.azure-automation.net/webhooks?token=**********"</span> `</span><br><span class="line">    <span class="literal">-Verbose</span> | <span class="built_in">Out-Null</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Output</span> <span class="string">"Trying to call SonarQube service..."</span></span><br><span class="line">    <span class="built_in">Invoke-RestMethod</span> <span class="literal">-Method</span> Get <span class="literal">-Uri</span> <span class="string">"http://johanclasson-sonarqube.westeurope.cloudapp.azure.com:9000"</span> `</span><br><span class="line">        <span class="literal">-Verbose</span> | <span class="built_in">Out-Null</span></span><br><span class="line">    <span class="built_in">Write-Output</span> <span class="string">"Found it!"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Output</span> <span class="string">"Nobody seems to be at home... (<span class="variable">$_</span>)"</span></span><br><span class="line">    <span class="built_in">Write-Output</span> <span class="string">"Starting up the virtual machine."</span></span><br><span class="line">    <span class="built_in">Invoke-RestMethod</span> <span class="literal">-Method</span> Post <span class="literal">-Uri</span> <span class="string">"https://s2events.azure-automation.net/webhooks?token=**********"</span> `</span><br><span class="line">        <span class="literal">-Verbose</span> | <span class="built_in">Out-Null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I hope I have inspired you to do automation of starting and stopping your VMs a little smarter. Best of luck with that!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2015-12-14-Automatically-Stop-Azure-Resource-Manager-VMs/" data-id="ck93ug7vx000bdsyg458be8ra" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-12-10-Fight-Technical-Debt-with-SonarQube" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015-12-10-Fight-Technical-Debt-with-SonarQube/" class="article-date">
  <time datetime="2015-12-09T23:00:00.000Z" itemprop="datePublished">2015-12-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015-12-10-Fight-Technical-Debt-with-SonarQube/">Fight Technical Debt With SonarQube</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The longer a project continues, the more apparently <em>innocent smells</em> are added to the source code. Eventually, you will be in a swamp which is very hard to get out of. Technical debt is a devious thing that sneaks up on you.</p>
<p>How would you like it if check-ins with smelly code are rejected automatically? That might be an efficient way to battle some of the technical debt anyway.</p>
<p>For a while now, Team Foundation Server (TFS) provides gated check-in builds. Such builds are triggered just before code is checked in. If the build fails, the check-in is rejected.</p>
<p>To be honest, I have never been a huge fan of gated check-ins. Most people remember to compile and run the tests before they check-in, so in my opinion, gated check-in builds were just something that were in the way.</p>
<p>However, with the more intelligent analysis of SonarQube, I think it is time to reevaluate that opinion and make use of gated check-in builds again.</p>
<h2 id="Introduction-to-SonarQube"><a href="#Introduction-to-SonarQube" class="headerlink" title="Introduction to SonarQube"></a>Introduction to SonarQube</h2><p><a href="http://www.sonarqube.org/" target="_blank" rel="noopener">SonarQube</a> is a service that can perform different forms of analysis of your project. It can run code analysis for you, such as FxCop and their own SonarLint. If you need to, <a href="https://github.com/SonarOpenCommunity/sonar-cxx/wiki/Create-Custom-Rules" target="_blank" rel="noopener">you can write custom rules</a> (in XPath format for C#) for any special validation you need to make.</p>
<p>Information that is produced by a build, such as code coverage and unit test execution results, can be reported to SonarQube. Analysis of that can be made on the entire code base or just on new code. Either from last analysis, or from the last version of the software.</p>
<p><img src="/2015-12-10-Fight-Technical-Debt-with-SonarQube/SonarQube-Example.png" alt="SonarQube Nemo Instance"></p>
<p>A great feature of SonarQube is that it can perform trend analysis of these project metrics. Metrics can be used both to visualize how the project has evolved over time, or to set a quality gate that code must pass before it is submitted. For example, SonarQube can be configured so that it is not ok if code coverage is lower than a certain value. It is wise to configure that threshold to be based on metrics from new or changed code since last analysis. This makes it easier to introduce such a rule midway in a project.</p>
<p>Another nice feature is that it is possible to see the project code with coverage highlighting. Not everyone care to run tests with coverage when they develop, and what is worse, not all have coverage software to begin with. Code coverage <a href="https://www.visualstudio.com/en-us/products/compare-visual-studio-2015-products-vs.aspx" target="_blank" rel="noopener">included in Visual Studio Enterprise</a>, or can be added with third party add-ons such as <a href="https://www.jetbrains.com/dotcover/" target="_blank" rel="noopener">dotCover</a>, but typically cost money.</p>
<p><em>(There are exceptions though. For example, <a href="http://testdriven.net/download.aspx" target="_blank" rel="noopener">nCover that comes bundled with TestDriven.Net</a> is free for personal and open source development.)</em></p>
<p>Anyhow, it is really great to have one place where all can see and reason about the current code coverage!</p>
<p>Here are some links to posts from the SonarQube blog:</p>
<ul>
<li><a href="http://www.sonarqube.org/mainstream-noun-the-principal-or-dominant-course-tendency-or-trend/" target="_blank" rel="noopener">Mainstream: Noun. The principal or dominant course, tendency, or trend</a></li>
<li><a href="http://www.sonarqube.org/do-you-care-about-your-code-track-code-coverage-on-new-code-right-now/" target="_blank" rel="noopener">Do you care about your code? Track code coverage on new code, right now!</a></li>
<li><a href="http://www.sonarqube.org/quality-gates-shall-your-projects-pass/" target="_blank" rel="noopener">Quality Gates: Shall your projects pass?</a></li>
</ul>
<h2 id="How-to-Get-Started"><a href="#How-to-Get-Started" class="headerlink" title="How to Get Started"></a>How to Get Started</h2><p>SonarQube is hosted as a Java application that is run inside a windows service. If you like, you can use the following powershell script to set up SonarQube on a fresh Windows Server 2012 R2.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install Java Runtime</span></span><br><span class="line">iex ((<span class="built_in">new-object</span> net.webclient).DownloadString(<span class="string">'https://chocolatey.org/install.ps1'</span>))</span><br><span class="line">cinst jre8 <span class="literal">-y</span></span><br><span class="line"><span class="comment"># Get latest version</span></span><br><span class="line"><span class="variable">$tmpFilename</span> = [<span class="type">System.IO.Path</span>]::GetTempFileName()</span><br><span class="line"><span class="variable">$latestVersionUrl</span> = wget <span class="literal">-Uri</span> <span class="string">"http://www.sonarqube.org/downloads/"</span> <span class="literal">-UseBasicParsing</span> | </span><br><span class="line">    select <span class="literal">-ExpandProperty</span> Links | select <span class="literal">-ExpandProperty</span> href |</span><br><span class="line">    ?&#123; <span class="variable">$_</span> <span class="operator">-match</span> <span class="string">"distribution(.*)sonarqube-(.*).zip<span class="variable">$</span>"</span> &#125; | sort <span class="literal">-Descending</span> | select <span class="literal">-First</span> <span class="number">1</span></span><br><span class="line">wget <span class="variable">$latestVersionUrl</span> <span class="literal">-UseBasicParsing</span> <span class="literal">-OutFile</span> <span class="variable">$tmpFilename</span></span><br><span class="line"><span class="built_in">Add-Type</span> <span class="literal">-AssemblyName</span> System.IO.Compression.FileSystem</span><br><span class="line">[<span class="type">System.IO.Compression.ZipFile</span>]::ExtractToDirectory(<span class="variable">$tmpFilename</span>, <span class="string">'c:\SonarQube'</span>)</span><br><span class="line">rm <span class="variable">$tmpFilename</span></span><br><span class="line"><span class="comment"># Install SonarQube service</span></span><br><span class="line"><span class="variable">$installerPath</span> = <span class="built_in">Resolve-Path</span> <span class="string">"C:\SonarQube\sonarqube-*\bin\windows-x86-64\InstallNTService.bat"</span> |</span><br><span class="line">    select <span class="literal">-ExpandProperty</span> Path</span><br><span class="line">&amp; <span class="variable">$installerPath</span></span><br><span class="line"><span class="comment"># Setup firewall rule</span></span><br><span class="line"><span class="built_in">New-NetFirewallRule</span> <span class="literal">-DisplayName</span> <span class="string">"SonarQube:9000"</span> <span class="literal">-Profile</span> Any <span class="literal">-LocalPort</span> <span class="number">9000</span> <span class="literal">-Protocol</span> tcp</span><br></pre></td></tr></table></figure>

<p>Then, you have to manually configure SonarQube with the following steps.</p>
<ul>
<li>Change the service logon to a local administrator account.</li>
<li>Consider connecting a real database to SonarQube, since migration of data is only supported if you have.<ul>
<li>See <a href="http://redirect.sonarsource.com/doc/sq-setup-guide-for-dotnet-users.html" target="_blank" rel="noopener">ALM Ranger Guidance</a> pp 12-15, 36-46 for how to configure SonarQube with SQL Server.</li>
</ul>
</li>
<li>Start service.<ul>
<li>Wait for Java(TM) Platform SE binary-processes to stop using 100% CPU.</li>
</ul>
</li>
<li>Browse to <a href="http://localhost:9000" target="_blank" rel="noopener">http://localhost:9000</a>.</li>
<li>Login with username <em>admin</em> and password <em>admin</em>.<ul>
<li>Consider to change the admin password</li>
</ul>
</li>
<li>Install the C# plugin under Administration - System - Update Center - Available.</li>
<li>Restart SonarQube service.<ul>
<li>Wait for Java(TM) Platform SE binary-processes to stop using 100% CPU.</li>
</ul>
</li>
<li>Create a new project under Administration - Projects - Management.</li>
</ul>
<h2 id="How-to-configure-VSTS-TFS"><a href="#How-to-configure-VSTS-TFS" class="headerlink" title="How to configure VSTS/TFS"></a>How to configure VSTS/TFS</h2><p>Team Foundation Server (TFS) 2015 and Visual Studio Team Services (VSTS) comes with two build tasks for retrieving and sending data to a SonarQube service. In you have not got these tasks installed, you can get them at <a href="https://github.com/Microsoft/vso-agent-tasks" target="_blank" rel="noopener">vso-agent-tasks</a>.</p>
<p>If you use Team Foundation Version Control (TFVC), you can use gated builds to prevent bad quality check-ins.</p>
<p>Gated builds are not available if you use Git. In that case, use SonarQube to analyse your pull requests instead. There are plugins for <a href="http://docs.sonarqube.org/display/PLUG/GitHub+Plugin" target="_blank" rel="noopener">GutHub</a> and <a href="https://github.com/AmadeusITGroup/sonar-stash" target="_blank" rel="noopener">BitBucket</a> that will do this for you. If you use VSTS/TFS there is no problem setting up the analysis as part of a pull request build.</p>
<p>If you have an old version of TFS, or have on-premise build agents, you need to install the SonarScanner manually. See the <a href="http://redirect.sonarsource.com/doc/sq-setup-guide-for-dotnet-users.html" target="_blank" rel="noopener">ALM Ranger Guidance</a> pp 18-21 for instructions.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2015-12-10-Fight-Technical-Debt-with-SonarQube/" data-id="ck93ug7vw000adsyg58k50u0b" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-11-27-Share-Code-With-Your-Own-NuGet-Feeds" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015-11-27-Share-Code-With-Your-Own-NuGet-Feeds/" class="article-date">
  <time datetime="2015-11-26T23:00:00.000Z" itemprop="datePublished">2015-11-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015-11-27-Share-Code-With-Your-Own-NuGet-Feeds/">Share Code With Your Own NuGet Feeds</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I think most of us are familiar with what NuGet is, and how it can be used to add packages from the official NuGet feed to our projects. We can all agree on that It is a real convenient way of sharing code.</p>
<p>What is strange is that I seldom find projects that use NuGet to share code within the project. Other more ad-hoc solutions are used instead. Have you ever opened a solution in Visual Studio to find that one of the projects that is listed in the solution is also included in an other solution? If you have, you might also have suffered from:</p>
<ul>
<li><em>Missing dependent projects</em>: If adding a project as a reference to another in one solution it is easy to forget adding the referenced project to all solutions where it is now needed.</li>
<li><em>Long relative paths which include the branch or repository name</em>: This the just awful! No, I do not make this up. I have seen it happen more than once… Your project will no longer be able to build or use any branch strategy.</li>
<li><em>NuGet packages which will not restore on build:</em> NuGet packages are restored to the packages folder. By default this folder is located where the solution file is. If a project has references to DLLs in a packages folder different than the packages folder of your current solution, you will not be able to build if you have to triggered a NuGet restore on that other solution beforehand.</li>
</ul>
<p>Another (bad) solution to the problem of sharing code is to simply copy it to all locations where one needs it. This might seem easy, but it makes it very hard to manage future updates to the shared code.</p>
<p>My observation is that many, if not all, developers consume NuGet feeds (at least the official one), but surprisingly few produce their own.</p>
<h2 id="Why-You-Should-Share-Code-With-Your-Own-NuGet-Feeds"><a href="#Why-You-Should-Share-Code-With-Your-Own-NuGet-Feeds" class="headerlink" title="Why You Should Share Code With Your Own NuGet Feeds"></a>Why You Should Share Code With Your Own NuGet Feeds</h2><p>There are many reasons for not publishing packages directly to the official NuGet feed.</p>
<ul>
<li>If you do not like your packages to be public, obviously.</li>
<li>It does not make sense to publish packages from your CI builds.</li>
<li>If you publish packages that does not work, you will get bad-will from people that get an opportunity to use them.</li>
<li>Once packages are published in the official feed, they cannot be deleted. To correct a mistake in a published package you have to publish a new one with a higher version instead.</li>
</ul>
<p>A better solution is to use your own NuGet feed, where you have more control over which packages exist and who that can access them. Perhaps it does not even make sense to make a package available to everyone. But if it does, it is a good idea to only push it to the official NuGet feed once the package has been verified in your own feed first.</p>
<h2 id="Feed-Hosting-Alternatives"><a href="#Feed-Hosting-Alternatives" class="headerlink" title="Feed Hosting Alternatives"></a>Feed Hosting Alternatives</h2><p>There are many ways you can host a NuGet feed. You should use the one that seems like the best depending on your project needs.</p>
<p>NuGet supports two types of security. To prevent anyone from pushing packages to your feed you can set an API key, which is a simple password that will be required to provide in the push command. To prevent anyone from consuming your feed, NuGet relies on authentication. For the most part basic authentication is used, although single-sign on with active directory is also possible.</p>
<p>Of course, if you really want to, you can customize NuGet to also use authentication for pushing packages. For example, this would be the case if you only want users belonging to a special group to be able to contribute to a feed.</p>
<h3 id="On-Premise-File-Share"><a href="#On-Premise-File-Share" class="headerlink" title="On Premise - File Share"></a>On Premise - File Share</h3><p>A fast and easy way to get started is to simply put the packages in a folder which is shared within your project. NuGet calls this a Local Feed.</p>
<p>Good:</p>
<ul>
<li>Everyone knows how to put files in a folder.</li>
</ul>
<p>Bad:</p>
<ul>
<li>File shares are typically not suited for public distribution.</li>
<li>If you use Visual Studio Team Services (VSTS), you have to configure an on premise build agent for access to the file share during builds.</li>
<li>File shares are cumbersome for employees to access when they are not at the office.</li>
<li>No download statistics.</li>
</ul>
<p>Make care that no firewall rules prevent you or the build server from accessing the file share.</p>
<h3 id="On-Premise-ASP-NET-Web-Application"><a href="#On-Premise-ASP-NET-Web-Application" class="headerlink" title="On Premise - ASP.NET Web Application"></a>On Premise - ASP.NET Web Application</h3><p>An alternative to using file shares for on premise hosting is to use an ASP.NET web application. If you need any special access policies or special requirements regarding handling of packages, this is the way to go.</p>
<p>NuGet calls this a Remote Feed, but can just as well be used internally. See <a href="https://docs.nuget.org/create/hosting-your-own-nuget-feeds" target="_blank" rel="noopener">the NuGet docs for how to create the ASP.NET Web Application</a>.</p>
<p>Good:</p>
<ul>
<li>If put on a computer with a public IP, the feed can be used for public distribution.</li>
<li>Fully customizable handling of NuGet packages.</li>
</ul>
<p>Bad:</p>
<ul>
<li>If the web application cannot be reached through internet, then it is cumbersome for employees to access it when they are not at the office.</li>
<li>If it is desired to secure online access, some authentication work needs to be put in to secure the feed.</li>
<li>No built in download statistics.</li>
</ul>
<p>To access a NuGet feed in VSTS, you need to configure a generic endpoint with the url of the application and the API key as the password. To get a build to publish packages to the feed, use the NuGet Publisher task and select the generic endpoint.</p>
<p>If you use authentication, you need to put in the username and password into NuGet. To my knowledge, this is not supported yet by the built in NuGet tasks of VSTS. I have made a <a href="https://github.com/johanclasson/vso-agent-tasks/" target="_blank" rel="noopener">demo of how it could be done in my VSO Agent Tasks repository on GitHub</a>. Look for NuGet Publisher With Credentials.</p>
<p>My guess is that Microsoft will eventually provide a special type of NuGet endpoint for this type of scenario.</p>
<h3 id="Azure-Free-Webbapp-ASP-NET-Web-Application"><a href="#Azure-Free-Webbapp-ASP-NET-Web-Application" class="headerlink" title="Azure Free Webbapp - ASP.NET Web Application"></a>Azure Free Webbapp - ASP.NET Web Application</h3><p>Instead of putting the web application on premise, you can put it as a web application on Azure. Free web apps comes with up to 1GB of storage.</p>
<p>The procedure to publish an ASP.NET web application to Azure is straightforward. Make sure you have selected Azure publishing when you create the web application project, then simply right click the project and select publish.</p>
<p>Good:</p>
<ul>
<li>Can be used for public distribution.</li>
<li>Fully customizable handling of NuGet packages.</li>
</ul>
<p>Bad:</p>
<ul>
<li>If desired, authentication work is needed for security.</li>
<li>No built in download statistics.</li>
</ul>
<h3 id="MyGet"><a href="#MyGet" class="headerlink" title="MyGet"></a>MyGet</h3><p><a href="https://www.myget.org/" target="_blank" rel="noopener">MyGet</a> offers an advanced service for NuGet feed hosting. Their free alternative gives 500 MB of storage for public feeds protected by one or many API keys. For a minor fee, you will get 1GB of storage and the possibility to secure your feeds with authentication.</p>
<p>Good:</p>
<ul>
<li>Can be used for public distribution.</li>
<li>Advanced features like feed aggregation, feed synchronization, web hooks, policies for automatic deletion of old packages, etc.</li>
</ul>
<p>Bad:</p>
<ul>
<li>It will cost you some dollars each month to have a private feed.</li>
</ul>
<p>MyGet feeds are accessed in VSTS with generic endpoints just like the ASP.NET web application.</p>
<p>MyGet supports a special way to add packages to a feed. By connecting a feed to a VSTS build, MyGet can search for any NuGet packages in the build artifacts and add the ones it find to your feed. This can be a convenient way to push packages to a private feed since you do not need to handle NuGet authentication credentials.</p>
<p>To add NuGet packages to the build artifacts in VSTS, use the built in Publish Build Artifacts task.</p>
<h3 id="VSTS-Package-Feeds"><a href="#VSTS-Package-Feeds" class="headerlink" title="VSTS Package Feeds"></a>VSTS Package Feeds</h3><p>Microsoft has just recently added a preview feature to VSTS called Package Management. It is free and offers unlimited storage. <em>(Well? I have not found any listed storage quotas in their documentation. I assume its unlimited since they have not got any storage quota for source code.)</em></p>
<p>Because of the authentication model around VSTS, only private feeds are available.</p>
<p>Good:</p>
<ul>
<li>Free private feeds</li>
</ul>
<p>Bad:</p>
<ul>
<li>No way to delete published packages. Yet anyway.</li>
</ul>
<p>To get started, find <a href="https://marketplace.visualstudio.com/items/ms.feed" target="_blank" rel="noopener">Package Management in the Visual Studio Marketplace</a> and click install.</p>
<p>A few days ago, Microsoft patched the NuGet Publisher task to support internal NuGet feeds. When VSTS is updated next time (my guess is that it will be in the middle of december) all accounts will get the updated version, but if you do not want to wait you can <a href="https://github.com/Microsoft/vso-agent-tasks/tree/master/Tasks/NugetPublisher" target="_blank" rel="noopener">update it yourself</a>.</p>
<p>This is how the task should look like:</p>
<p><img src="/2015-11-27-Share-Code-With-Your-Own-NuGet-Feeds/UpdatedNuGetPublisherTask.png" alt="Updated Nuget Publisher Task"></p>
<p>Microsoft recommends that you <a href="https://www.visualstudio.com/get-started/package/use/consume#current" target="_blank" rel="noopener">consume VSTS package feeds in Visual Studio 2015 Update 1</a>. Since that version is not released yet? you can either use the <a href="https://www.visualstudio.com/en-us/news/vs2015-update1-vs.aspx" target="_blank" rel="noopener">release candidate</a>, or use the <a href="https://www.visualstudio.com/get-started/package/use/publish#auth-from-nuget" target="_blank" rel="noopener">workflow for older clients</a> which describes how to add the credentials to your local NuGet package sources.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2015-11-27-Share-Code-With-Your-Own-NuGet-Feeds/" data-id="ck93ug7vv0009dsyg3n2wc6bq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-11-23-Apply-Semantic-Versioning-to-Assemblies" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015-11-23-Apply-Semantic-Versioning-to-Assemblies/" class="article-date">
  <time datetime="2015-11-22T23:00:00.000Z" itemprop="datePublished">2015-11-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015-11-23-Apply-Semantic-Versioning-to-Assemblies/">Apply Semantic Versioning to Assemblies</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>For some time now, Community TFS Build Extensions has provided a <a href="https://tfsbuildextensions.codeplex.com/SourceControl/latest#Scripts/ApplyVersionToAssemblies.ps1" target="_blank" rel="noopener">PowerShell script for automatic versioning of assemblies</a> during a build. This simple script served me well, until I heard about <a href="http://semver.org/" target="_blank" rel="noopener">semantic versioning</a>… To make a long story short, semantic versioning is a standard way to reason about version numbering.</p>
<p>There are quite a few version patterns that are in use, where Major.Minor.Patch.Build is a common one. This is however not a valid format according to the semantic versioning specification, although I suspect that many relates to that pattern when they talk about versioning.</p>
<p>The version patterns that NuGet supports are both Major.Minor.Patch and Major.Minor.Patch-Prerelease, see the <a href="https://docs.nuget.org/create/versioning" target="_blank" rel="noopener">versioning documentation of NuGet</a> for more details.  </p>
<p>Up until now I have struggled with setting prerelease versions for NuGet packages automatically during a build. My problem with the standard .Net assembly version, which was the version that I used to focus on, is that it does not support the prerelease pattern. Because of this, I used to include the NuGet package version either directly in the nuspec-file or as an input parameter for the build.</p>
<p>A couple of days ago I once again found myself in need of publishing a series of prerelease NuGet packages, and this time I found a way to make the versioning happen automatically. I discovered that .Net supports not only one, but three version types. I also found out how easy it is to create custom tools for the new build workflow in Visual Studio Team Services (VSTS) (Formerly Visual Studio Online) and TFS 2015.</p>
<h2 id="Customizing-the-Build-To-Version-Assemblies"><a href="#Customizing-the-Build-To-Version-Assemblies" class="headerlink" title="Customizing the Build To Version Assemblies"></a>Customizing the Build To Version Assemblies</h2><p>VSTS and TFS 2015 bring a new build workflow with a set of predefined tools organized into build steps. Needless to say, although that these tools are great they do not cover all your customization scenarios of your build- or release flow. Invoking PowerShell scripts is often an appealing option for this kind of customization. Using PowerShell scripts is especially a good idea when you are making changes that are unique for your solution. Just write your script and invoke it!</p>
<p>Working with builds that directly invokes PowerShell scripts has its limitations:</p>
<ul>
<li>If you have to deal with multiple arguments it is easy to get one of them wrong.</li>
<li>Often when you update a PowerShell script you will affect its signature, and you might have to manually update its calling command at many places.</li>
<li>Each build have to include the PowerShell script-files in its source code.</li>
</ul>
<p>Fortunately, it is relatively straightforward to package your scripts in a task of your own. Once such a task is installed, it can be used by all builds in the entire collection.</p>
<h2 id="How-to-Create-a-New-Task"><a href="#How-to-Create-a-New-Task" class="headerlink" title="How to Create a New Task"></a>How to Create a New Task</h2><p>I have not found any official documentation on how to create new tasks, but the ones that are included in VSTS/TFS 2015 by default are available as <a href="https://github.com/Microsoft/vso-agent-tasks" target="_blank" rel="noopener">open source from Microsofts GitHub account</a>. A pragmatic approach for your first homebrewed task could be to copy an existing one and customize it to your needs. Just do not forget to generate a new ID!</p>
<p>The minimum task should include <code>task.json</code>, <code>icon.png/svg</code> and <em>any files</em> that need to be invoked. The backend (build agents, which can be installed on both Windows and Linux) can handle running Node-, PowerShell-, and Bash scripts as well as invoking a process directly.</p>
<h2 id="Installation-of-Tasks"><a href="#Installation-of-Tasks" class="headerlink" title="Installation of Tasks"></a>Installation of Tasks</h2><p>The <a href="https://github.com/Microsoft/tfs-cli" target="_blank" rel="noopener">TFS Cross Platform Command Line utility (tfx-cli)</a> is used to install tasks. It is built on Node.js, so if you have not already got Node.js you have to install it. One way to do that it is to use the Chocolatey command <code>cinst nodejs</code>.</p>
<p>Then, to install a task run the following commands in a Node.js command prompt:</p>
<ul>
<li><code>npm install -g tfx-cli</code> - <em>This installs the tfx-cli tool.</em></li>
<li><code>tfx login</code> - <em>The login is reused throughout the entire session.</em><ul>
<li>Enter collection url &gt; <code>https://yourname.visualstudio.com/DefaultCollection</code></li>
<li>Enter personal access token &gt; <code>2lqewmdba7theldpuoqn7zgs46bmz5c2ppkazlwvk2z2segsgqrq</code> - <em>This is obviously a bogus token… You can add tokens to access your account at <a href="https://yourname.visualstudio.com/_details/security/tokens" target="_blank" rel="noopener">https://yourname.visualstudio.com/_details/security/tokens</a>.</em> </li>
</ul>
</li>
<li><code>tfx build tasks upload c:\path-to-repo\vso-agent-tasks\ApplySemanticVersioningToAssemblies</code><ul>
<li><em>If you change your mind and do not want a task anymore, you can remove it with</em> <code>tfx build tasks delete b8df3d76-4ee4-45a9-a659-6ead63b536b4</code>, <em>where the Guid is easiest found in the task.json of your task.</em></li>
</ul>
</li>
</ul>
<p>If you make a change to a task that you have previously uploaded, you have to bump its version before you upload it again. The server does not allow overwriting the content of an existing version.</p>
<h2 id="Describing-the-Apply-Semantic-Versioning-to-Assemblies-Build-Task"><a href="#Describing-the-Apply-Semantic-Versioning-to-Assemblies-Build-Task" class="headerlink" title="Describing the Apply Semantic Versioning to Assemblies Build Task"></a>Describing the Apply Semantic Versioning to Assemblies Build Task</h2><p>The solution to my NuGet package versioning problem was to use the build number to set the versions, and to configure the prerelease name in a build task. To make meaningful semantic versions of all three version types of .Net, they are set to different values. I have published the Apply Semantic Versioning to Assemblies task in my <a href="https://github.com/johanclasson/vso-agent-tasks" target="_blank" rel="noopener">VSO-Agent-Tasks GitHub repository</a> so you can make use of it.</p>
<p>Added as a step in a build, this is how it looks.</p>
<p><img src="/2015-11-23-Apply-Semantic-Versioning-to-Assemblies/ApplySemanticVersioningToAssemblies.png" alt="Apply Semantic Versioning to Assemblies User Interface"></p>
<h3 id="The-Three-Assembly-Versions-Supported-by-Net"><a href="#The-Three-Assembly-Versions-Supported-by-Net" class="headerlink" title="The Three Assembly Versions Supported by .Net"></a>The Three Assembly Versions Supported by .Net</h3><p>The <code>AssemblyVersion</code> is the number that is used by a dll to point out a reference to a specific version of another dll. If this version is changed in a newer dll, those references needs to be updated to target that dll instead. If you follow semantic versioning, the first two version numbers are the ones to increase when the public API changes. Therefore it is a good idea to include just those in the assembly version.</p>
<p>The <code>AssemblyFileVersion</code> is not used by .Net directly, but is instead of value as a historical reference. If you would ever try to figure out from what build a dll has come from, then the assembly file version would help you answer that.</p>
<p>The <code>AssemblyInformationalVersion</code> is something human-readable that describes a version, for example 1.0-RC1. This can theoretically be whatever text you prefer, but in this task it is only configurable to the format 1.2.3-abc0004. Note that the build number is left padded with zeros. The reason for this is that NuGet sorts prerelease versions alphabetically. Semantic versioning supports Major.Minor.Patch-Prerelease.Build, but NuGet does not. </p>
<p>A great thing about the <code>AssemblyInformationalVersion</code> is that NuGet will use that for the package version if it is present. Problem solved!  </p>
<h3 id="How-Does-It-Work"><a href="#How-Does-It-Work" class="headerlink" title="How Does It Work?"></a>How Does It Work?</h3><p>By use of a regular expression, exactly four version numbers (for example 1.2.3.4) are extracted from the build number. All AssemblyInfo.cs files are then iterated and versions are set in the following attributes:</p>
<ul>
<li><code>AssemblyVersion</code> - <em>Is set to either 1, 1.2, 1.2.3 or 1.2.3.4 depending on what you enter under “Version Numbers in AssemblyVersion-attribute”. 1.2 is the default.</em></li>
<li><code>AssemblyFileVersion</code> - <em>Is set to 1.2.3.4. This is not configurable.</em> </li>
<li><code>AssemblyInformationalVersion</code> - <em>Is set to either 1.2.3, 1.2.3-abc or 1.2.3-abc0004 depending on what you enter under “Make Release Version”, “Prerelease Name” and “Include Build Revision Number”.</em> </li>
</ul>
<p>When one of these attributes are present in the AssemblyInfo.cs-file, their entered version-string is replaced. Attributes which are not present are instead added at the end of the file.</p>
<p>As you well understand, this task must be placed before the build task to make any difference.</p>
<h3 id="Practical-Use"><a href="#Practical-Use" class="headerlink" title="Practical Use"></a>Practical Use</h3><p>The informational version format 1.2.3-abc0004, which is compatible with NuGet, can be used to represent prerelease packages from your nightly builds. For example 2.1.3-build0421 could be the semantic version for 421st build targeting the fourth bugfix of the second API update of the 2.0 release.</p>
<p>When packing a project package and to have NuGet use the informational version number, just set the version tag to <code>&lt;version&gt;$version$&lt;/version&gt;</code> in the nuspec-file and you are good to go. </p>
<p>When you are planning to make a new release, you might find that it is a good idea to have the version numbers you intend to have on release fixed and let the build revision number update until you are done. If this is the case, use <code>$(BuildDefinitionName).2.1.3$(Rev:.r)</code> as the <em>Build number format</em> for the build. When you think that you are done, you can simply tick “Make Release Version” and build to make a release version which in this case would be 2.1.3. If you would like to build a release candidate, untick “Include Build Revision Number” and replace the “Prerelease Name” to for example RC1 which would result in 2.1.3-RC1. </p>
<h3 id="Advanced-Options"><a href="#Advanced-Options" class="headerlink" title="Advanced Options"></a>Advanced Options</h3><p>You can change the <em>Build Number Pattern</em> that is used to extract the version numbers from the build number. If you do, then make sure that you enter matching <em>Split Characters</em> and that there would still be exactly four versions present.</p>
<h4 id="Other-Tools-to-Consider"><a href="#Other-Tools-to-Consider" class="headerlink" title="Other Tools to Consider"></a>Other Tools to Consider</h4><p>If you are using Git as version control, and do not mind some additional complexity, <a href="https://github.com/GitTools/GitVersion" target="_blank" rel="noopener">GitVersion</a> is an excellent tool. It fetch the version from the branch name, branch relations, commit tags and commit messages. This method of finding the version is superior to fetching it from the build number since you do not have to regularly update the build number format as you make releases.</p>
<p>But it forces you to follow a specific branch- and pull request strategy (although I think it’s a good one) in your development process. Not everyone would like to do that.</p>
<p>An other option is to use the versioning capabilities of the built in <a href="https://github.com/Microsoft/vso-agent-tasks/tree/master/Tasks/NugetPackager" target="_blank" rel="noopener">NuGet Packager task</a>. It contains an option to ?Use Build number to version package? which if checked sets a version to the NuGet package by an argument to the nuget.exe pack command. That version is extracted from the build number in a similar fashion as my Apply Semantic Versioning to Assemblies task does it, but in this case the version is fixed to be in the format Major.Minor.Patch.Build. Using this approach does not version the assemblies, nor does it support semantic versioning.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2015-11-23-Apply-Semantic-Versioning-to-Assemblies/" data-id="ck93ug7vv0008dsyg57f4fyqw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-09-28-Git-Push-Only-When-You-Have-Something-to-Share" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015-09-28-Git-Push-Only-When-You-Have-Something-to-Share/" class="article-date">
  <time datetime="2015-09-27T22:00:00.000Z" itemprop="datePublished">2015-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015-09-28-Git-Push-Only-When-You-Have-Something-to-Share/">Git Push Only When You Have Something to Share</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Git is a source control version system that encourages you to commit changes often. Since you have your own local repository it is not that important that everything that is committed is of premium quality. You can always amend, squach, reword, and even remove commits later before you make your changes public to your team.</p>
<h2 id="Why-you-should-commit-often"><a href="#Why-you-should-commit-often" class="headerlink" title="Why you should commit often"></a>Why you should commit often</h2><p>It is actually a good practice to commit as soon as you get something right. Even the smallest change that works is best put into history. To commit often brings a few advantages that you would not have anyway:</p>
<ul>
<li>You never need to worry that any changes (and even temporary such) are lost if you screw up.</li>
<li>If you try something out, and it shows that it does not work, you can reset the branch instead of changing back the code manually.</li>
<li>If you later on realize that a commit is not needed you can rebase and remove that commit from history.</li>
<li>If you fix something important that someone else in your team suddenly needs, then that person can cherry pick your commit instead of making the change manually.</li>
<li>? need I go on?</li>
</ul>
<h2 id="Git-push-only-when-you-have-something-to-share"><a href="#Git-push-only-when-you-have-something-to-share" class="headerlink" title="Git push only when you have something to share"></a>Git push only when you have something to share</h2><p>Another good practice is that every branch that is public should only contain work that is complete, done, and if you will done-done. For example, one should at any time be able to do a pull request of that work and have it merged into master.</p>
<p>This makes it super easy for your team members to know what branches they can use to build features of their own upon. Obviously all public branches!</p>
<p>When using the distributed workflow that git allows, with lots of branches that are often merged all over the place, it?s easy to pick a wrong branch by mistake. The risk of that happening is lower if there are no junk cloading the things that are actually important.</p>
<p>In other words, invoke the git push only when you have something to share. And that something should be the kind that is worth sharing! Please keep your public repository tidy.</p>
<h2 id="The-fear-of-hardware-failure"><a href="#The-fear-of-hardware-failure" class="headerlink" title="The fear of hardware failure"></a>The fear of hardware failure</h2><p>One disadvantage of having lots of changes on your local machine is that they can go up in smoke if your computer dies on you. Instead of pushing commits to your public repository you need to address this in another manner.</p>
<p>You could set up a remote repository and push your changes there to backup. But I would not recommend it. Having more than one remote really is a hazzle! Especially when doing it for backup reasons only.</p>
<p>One more direct way is to simply do regular copies of your local repositories to a remote location, say a network share, or why not OneDrive? You do not need to copy your checked out branch with binaries and what not. All that is needed is the .git folder.</p>
<h2 id="PowerShell-to-the-rescue"><a href="#PowerShell-to-the-rescue" class="headerlink" title="PowerShell to the rescue"></a>PowerShell to the rescue</h2><p>My approach is to schedule the following PowerShell to run once each hour. Problem solved!</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">CmdletBinding</span>()]</span><br><span class="line"><span class="keyword">Param</span>(</span><br><span class="line">    [<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$True</span>)]</span><br><span class="line">    [<span class="built_in">string</span>]<span class="variable">$Source</span>,</span><br><span class="line">    [<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$True</span>)]</span><br><span class="line">    [<span class="built_in">string</span>]<span class="variable">$Target</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">gci <span class="variable">$Source</span> <span class="literal">-Recurse</span> <span class="literal">-Filter</span> <span class="string">".git"</span> <span class="literal">-Force</span> <span class="literal">-Directory</span> | %&#123;</span><br><span class="line">    <span class="variable">$dir</span> = <span class="built_in">Join-Path</span> (<span class="built_in">Join-Path</span> <span class="variable">$target</span> <span class="variable">$_</span>.Parent.Name) <span class="string">".git"</span></span><br><span class="line">    robocopy <span class="variable">$_</span>.FullName <span class="variable">$dir</span> /MIR | <span class="built_in">Out-Null</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$LASTEXITCODE</span> <span class="operator">-gt</span> <span class="number">7</span>) &#123;</span><br><span class="line">        <span class="built_in">Write-Error</span> <span class="string">"RoboCopy exited with code <span class="variable">$</span>(<span class="variable">$LASTEXITCODE</span>). Something bad happended when taking backup of <span class="variable">$</span>(<span class="variable">$_</span>.Parent.FullName)!"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Output</span> <span class="string">"Mirrored content of <span class="variable">$</span>(<span class="variable">$_</span>.FullName) to <span class="variable">$dir</span>"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For example, I invoke it by <code>.\Backup-Git.ps1 -Source C:\Dev -Target C:\OneDrive\Backup\Git\Rusty</code>. </p>
<p>I have many computers, and I keep a separate backup folder for each. (One of them is called Rusty?)</p>
<p>My dev folder contains lots of clones of other people’s repositories which I am not interested in backupping. If you make it a habit to remove their .git folders then they will not get mirrored to your backup destination.</p>
<p>You can surely think of something else that suites your workflow better! :)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2015-09-28-Git-Push-Only-When-You-Have-Something-to-Share/" data-id="ck93ug7vu0007dsygb8t32liy" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-06-26-Pull-Requests-in-TFS-2015" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015-06-26-Pull-Requests-in-TFS-2015/" class="article-date">
  <time datetime="2015-06-25T22:00:00.000Z" itemprop="datePublished">2015-06-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015-06-26-Pull-Requests-in-TFS-2015/">Pull Requests in TFS 2015</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>We all agree on that doing code review is a good thing. But you need a natural way to conduct code reviews in your team workflow for them to happen. One such is to review all code before it’s pushed to the main branch. In a <a href="http://oss-watch.ac.uk/resources/pullrequest" target="_blank" rel="noopener">distributed version control system such as Git you can create a pull request</a> to initiate such a review. </p>
<p>GitHub has long supported a nice graphical experience working with pull requests, and TFS and Visual Studio Online (VSO) have just recently caught up. With the release of TFS 2015, they are now in my opinion quite similar in functionally all of them.</p>
<p>What is of importance when reviewing someone else’s changes is, aside from being able to comment on them, to also to know if the build still pass if they are applied. Obviously, there is no use to start the review if the changes can’t be compiled. Nor if they break any automatic tests.</p>
<p>In this post I will use the same <a href="https://github.com/johanclasson/PowerShell" target="_blank" rel="noopener">PowerShell repository</a> as in my <a href="http://blog.nethouse.se/2015/07/21/build-your-github-repository-with-vso/" target="_blank" rel="noopener">previous post</a>. I will use VSO, but I could just as well have used TFS 2015. For the moment, they are identical with regards to pull request functionality.</p>
<h2 id="Support-for-Pull-Requests-in-TFS-2015-VSO-and-GitHub"><a href="#Support-for-Pull-Requests-in-TFS-2015-VSO-and-GitHub" class="headerlink" title="Support for Pull Requests in TFS 2015, VSO and GitHub"></a>Support for Pull Requests in TFS 2015, VSO and GitHub</h2><p>If you have your automatic builds run by a build agent hosted in VSO for a Git repository which is also hosted in VSO, it is no surprise that it works out of the box.</p>
<p>But what about if you have your repository in GitHub? Triggering VSO builds for pull requests in a GitHub repository is something you can do, but there is no built in functionally for reporting the build results to the pull request. <a href="https://msdn.microsoft.com/Library/vs/alm/Build/github/index" target="_blank" rel="noopener">Not yet anyway</a>.</p>
<p>If you have your code on GitHub, then moving the source code to VSO might be something that you are not prepared to do. If so, you can host your own build server. There exists plugins for both Jenkins and TeamCity for reporting build results to a pull request on GitHub.</p>
<p>When preparing this post, pushing the GitHub branches of my test repository to VSO was nothing I had any objections against. Pushing all branches to another remote host can be done with the following commands: </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote add vso https://johanclasson.visualstudio.com/DefaultCollection/_git/PowerShell</span><br><span class="line">git push <span class="literal">-u</span> vso -<span class="literal">-all</span></span><br></pre></td></tr></table></figure>

<h2 id="Configuring-Automatic-Building-of-Pull-Requests"><a href="#Configuring-Automatic-Building-of-Pull-Requests" class="headerlink" title="Configuring Automatic Building of Pull Requests"></a>Configuring Automatic Building of Pull Requests</h2><p>First create a build definition for your branch, if you have not already got one. Next head over to the team project settings page. Under the <em>Version Control</em> tab, you can set up something called branch policies.</p>
<p>Under <em>Automatically build pull requests</em> you can select the build definition that you want to be triggered.</p>
<p>Regarding pull requests in TFS 2015 and VSO, you can do some things which you can’t in GitHub. Under <em>Code review requirements</em> you can enforce that all commits to a branch have to be made through pull requests.</p>
<p>By default, the user who has made a pull request can’t approve it. If you really want this to be possible you can change this setting here as well.</p>
<p><img src="/2015-06-26-Pull-Requests-in-TFS-2015/2.1-Pull-Request-Settings.png" alt="Branch policies for pull requests in TFS 2015"></p>
<p>With <em>Add a new path</em> you can require specific reviewers for portions of your code base. For example if you got sensitive files in a specific folder, you can be sure that pull requests that change files in that folder is reviewed by an expert in your team.</p>
<h2 id="Working-with-Pull-Requests"><a href="#Working-with-Pull-Requests" class="headerlink" title="Working with Pull Requests"></a>Working with Pull Requests</h2><p>If you have read my <a href="http://blog.nethouse.se/2015/07/21/build-your-github-repository-with-vso/" target="_blank" rel="noopener">previous post</a> you know that in my test repository, several of the automatic tests failed. In a villainous attempt to fix this, I created a feature1 branch, and committed and pushed a change to it.</p>
<h3 id="Create-Pull-Requests"><a href="#Create-Pull-Requests" class="headerlink" title="Create Pull Requests"></a>Create Pull Requests</h3><p>Under the <em>CODE - Pull Requests</em> tab, you can either click <em>New Pull Request</em> in the top left, or the blue <em>Create Pull Request</em> quick button in the middle.</p>
<p><img src="/2015-06-26-Pull-Requests-in-TFS-2015/2.2-Create-Pull-Request.png" alt="Create a new pull request"></p>
<p>This opens a page where you can edit details of the pull request which it’s going to be created. Make sure that you select the correct target branch, next to <em>relative to</em>. The description field is prefilled with the commit comments from the source branch.</p>
<p><img src="/2015-06-26-Pull-Requests-in-TFS-2015/2.3-Edit-Pull-Request-Details.png" alt="Edit pull request details"></p>
<p>As you can see, I’ve cheated by commenting out the command to run the automatic tests. For sure, that would make no tests fail!  </p>
<h3 id="Review-Pull-Requests"><a href="#Review-Pull-Requests" class="headerlink" title="Review Pull Requests"></a>Review Pull Requests</h3><p>Luckily some decent person is likely to review the pull request before it is merged. Under <em>CODE - Pull Requests</em> you can see active pull requests. Clicking the pull request will open it in review mode, looking like this: </p>
<p><img src="/2015-06-26-Pull-Requests-in-TFS-2015/2.4-Pull-Request-Overview.png" alt="Review pull request"></p>
<p>There you can comment on source code lines and also place general comments. Note the <em>Build succeeded</em> badge in to top right, indicating that all is well. But in this case, if you inspect the <em>details</em> it will be obvious that no tests have been run.</p>
<p>One could click <em>Complete pull request</em> to accept- and have it merged to the main branch. Then it is a good idea to click <em>Delete source branch</em> to remove the branch, which probably will no longer be used. </p>
<p>But in this case one should click <em>Abandon</em>, and give the person who made the request a lesson in code ethics…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2015-06-26-Pull-Requests-in-TFS-2015/" data-id="ck93ug7vt0006dsyghwsx7f3b" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-06-21-Build-Your-GitHub-Repository-With-VSO" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015-06-21-Build-Your-GitHub-Repository-With-VSO/" class="article-date">
  <time datetime="2015-06-20T22:00:00.000Z" itemprop="datePublished">2015-06-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015-06-21-Build-Your-GitHub-Repository-With-VSO/">Build Your GitHub Repository With VSO</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If you work with an open source project, or by other means want to share your project with unknown people, GitHub is a great place to store source code. It does not provide any support for building, versioning or deployment, so you have to set these things up somewhere else.</p>
<p>You can use either Team City, Jenkins or TFS 2015 to host your own build service without so much trouble. If you are not so keen on running your own machine, you can use an online service instead. One of those is Visual Studio Online (VSO), which is my favorite in this case since it’s build agent:</p>
<ul>
<li>Integrates well with GitHub.</li>
<li>Is free to use for <a href="http://azure.microsoft.com/en-us/pricing/details/visual-studio-online/" target="_blank" rel="noopener">60 minutes each month</a>.</li>
<li>Can be used to build almost anything, and comes bundled with functionality for compiling .Net, Javascript, Ant, Maven, Android, Xamarin, Xcode, among others.</li>
<li>Is easy to customize for those special needs that you almost always have.</li>
</ul>
<p>With the new functionality introduced for TFS 2015, VSO build has become very capable. For a description about what is available read <a href="http://www.colinsalmcorner.com/post/why-you-should-switch-to-build-vnext" target="_blank" rel="noopener">Why You Should Switch to Build VNext, by Colin Dembovsky</a>.</p>
<p>To demonstrate the ability for customization and doing something completely different in a build, I will use my <a href="https://github.com/johanclasson/PowerShell" target="_blank" rel="noopener">PowerShell repository on GitHub</a> as an example in this post.</p>
<h2 id="Connecting-VSO-to-GitHub"><a href="#Connecting-VSO-to-GitHub" class="headerlink" title="Connecting VSO to GitHub"></a>Connecting VSO to GitHub</h2><p>If you do not already have an account on visualstudio.com, create one now. Once logged in create a team project representing your GitHub repository.</p>
<p>In TFS a team project is a container where repositories, work items, source code, and builds are kept.</p>
<p>Head over to Builds and create a new build definition. Enter your connection details under the Repository tab.</p>
<p><img src="/2015-06-21-Build-Your-GitHub-Repository-With-VSO/Build-GH-with-VSO-1.1-GitHub-Repo.png" alt="GitHub Repo"></p>
<p>Authorization to GitHub is made through an access token, that can be generated under <a href="http://github.com/settings/tokens" target="_blank" rel="noopener">personal access token on GitHub</a>.</p>
<p><img src="/2015-06-21-Build-Your-GitHub-Repository-With-VSO/Build-GH-with-VSO-1.2-GitHub-Access-Token.png" alt="GitHub Access Token"></p>
<h2 id="Build-Your-GitHub-Repository-With-VSO"><a href="#Build-Your-GitHub-Repository-With-VSO" class="headerlink" title="Build Your GitHub Repository With VSO"></a>Build Your GitHub Repository With VSO</h2><p>Since I used a PowerShell repository as an example there is nothing to compile in the build, but the purpose is only to run a series of tests.</p>
<p>To my knowledge, the most used testing framework for PowerShell is <a href="https://github.com/pester/Pester" target="_blank" rel="noopener">Pester</a>. The hosted build agents does not have the Pester module installed. So to be able to run the tests, Pester will first have to be installed. I have written a script for this, and which is explained in more detail later in this post.</p>
<p>What is performed by a build is configured under the build tab, by adding one of the <a href="https://msdn.microsoft.com/en-us/Library/vs/alm/Build/overview" target="_blank" rel="noopener">available build steps</a>. Running a series of Pester tests can be done by executing a PowerShell build step.</p>
<p><img src="/2015-06-21-Build-Your-GitHub-Repository-With-VSO/Build-GH-with-VSO-1.3-GitHub-Build-Steps.png" alt="Build Steps to Build Your GitHub Repository With VSO"></p>
<p>To have the build kick off automatically when changes are pushed to the Repository, configure the build with a Continuous Integration trigger. Use Filters to select what branches will trigger a build. But you can also build your GitHub repository with VSO manually by pressing the <em>Queue build</em> button.</p>
<h2 id="How-to-Run-Pester-in-VSO"><a href="#How-to-Run-Pester-in-VSO" class="headerlink" title="How to Run Pester in VSO"></a>How to Run Pester in VSO</h2><p><a href="https://gist.github.com/johanclasson/2e4770044f44e8c2fb43" target="_blank" rel="noopener">https://gist.github.com/johanclasson/2e4770044f44e8c2fb43</a></p>
<h2 id="Build-Result-and-Lessons-Learned"><a href="#Build-Result-and-Lessons-Learned" class="headerlink" title="Build Result and Lessons Learned"></a>Build Result and Lessons Learned</h2><p><img src="/2015-06-21-Build-Your-GitHub-Repository-With-VSO/Build-GH-with-VSO-1.5-Build-Failed.png" alt="Build Failed"></p>
<p>As can be seen, the build failed because 10 tests failed.</p>
<p>This was actually the first time I executed the tests on another machine than my own. It turned out that some tests weren’t as independent as I thought. And some could not even execute on a Windows Core, which is the operating system used by the VSO hosted build agents.</p>
<p>Running tests automatically is a good idea, and in this case I learned the hard way that it’s best to start using an external build service from the very beginning. Even for a scripting language.</p>
<p>One of the modules in my PowerShell repository uses web scraping to get information from a web page, and if the layout changes to much it will no longer work. To alert me when it has broken it is convenient to schedule a build every night and set up an email alert for failed builds.</p>
<h3 id="Build-Badge"><a href="#Build-Badge" class="headerlink" title="Build Badge"></a>Build Badge</h3><p>VSO and TFS 2015 provides a way for you to present a badge on a website to tell whether you build passes or not.</p>
<p>To enable this feature you can check the <em>Badge enabled</em> checkbox under the General tab of a build definition. When you save you will get an url to a SVG image.</p>
<p>Go build something!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2015-06-21-Build-Your-GitHub-Repository-With-VSO/" data-id="ck93ug7vt0005dsygbn5e1reu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-06-01-Hyper-V-Environment-Templating" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015-06-01-Hyper-V-Environment-Templating/" class="article-date">
  <time datetime="2015-05-31T22:00:00.000Z" itemprop="datePublished">2015-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015-06-01-Hyper-V-Environment-Templating/">Hyper-v Environment Templating</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Have you ever felt the need to have a test environment set up on your personal computer? Or perhaps to have an automated way to set up an environment in your Continuous Integration workflow? If it’s done manually, this is a tedious and I believe often error prone activity. But if it’s automated through for example my script demonstrated below, you can have your new virtual machines starting in just seconds.</p>
<p>I have made a <a href="https://github.com/johanclasson/PowerShell/tree/master/HyperV" target="_blank" rel="noopener">PowerShell Module</a> that contains a function that creates virtual-networks and computers in Hyper-V according to an XML-configuration. It’s idempotent enough so that it does not try to create something that is already there.</p>
<p>The reason that I choose Hyper-V as hypervisor is just that it’s something that is accessible for most people without any extra cost. But I believe that it should not be hard to make the module to work with another, for example Azure, if you prefer to have your environments there instead.</p>
<p>When developing, I prefer to have my virtual machines locally because it’s much faster. A Windows Server 2012 R2 Core instance will run with 512MB of RAM and requires about 6GB of disk space. This makes it not much of a deal to run several virtual machines even on an laptop.</p>
<p>In this post, I will use Windows as example since it’s the technology that I’m most familiar with. But this technique should work just as good with any other operating systems that run on Hyper-V.</p>
<h2 id="Alternative-Tool"><a href="#Alternative-Tool" class="headerlink" title="Alternative Tool"></a>Alternative Tool</h2><p>Microsoft already has a similar tool called <a href="http://blogs.technet.com/b/privatecloud/archive/2013/02/08/deployment-introducing-powershell-deployment-toolkit.aspx" target="_blank" rel="noopener">PowerShell Deployment Toolkit</a>, primarily for deployment of System Center 2012. Instead of using it, I preferred to write my own because I wanted something more lightweight.</p>
<h2 id="Setup-Windows-Server-Templates"><a href="#Setup-Windows-Server-Templates" class="headerlink" title="Setup Windows Server Templates"></a>Setup Windows Server Templates</h2><p>I prefer to work with Windows Server Core instances for two reasons. First, since they do not contain any GUI they consume less RAM and disk-space. And second, if you ever feel a need to RDP to a test server, I think it’s a sign that you have failed to fulfill Continuous Integration. Deployment of both applications and OS-configuration are done best with a tools like PowerShell DSC, Chef or Puppet. One should not have to log on to a server for deployment reasons.</p>
<p>To speed up creation of virtual machines one can create templates of already preconfigured instances of Windows. Then, you do not have to do the installation of the operating system manually, nor whatever other steps you normally do when creating a new virtual machine.</p>
<p>To create a template one should not just make a copy of an other virtual machine, but instead anonymize it first. You have to remove unique identifiers, such as for example SID and computer name. Microsoft provides a tool for this purpose called <a href="https://technet.microsoft.com/en-us/library/hh825033.aspx" target="_blank" rel="noopener">Sysprep</a>. For details about what it removes, please see <a href="https://4sysops.com/archives/why-sysprep-is-an-obligatory-windows-deployment-tool-part-1-all-the-important-sysprep-functions/" target="_blank" rel="noopener">this blog post by Michael Pietroforte</a>.</p>
<p>You can run Sysprep by double clicking its executive, or by invoking it through command line in the following manner.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:\windows\system32\sysprep\sysprep.exe &#x2F;oobe &#x2F;generalize &#x2F;shutdown</span><br></pre></td></tr></table></figure>

<p>After Sysprep has run on a computer, and when first booting it up you need to fill in some details such as locale, administrator account password and license key.</p>
<h3 id="Automated-Installation"><a href="#Automated-Installation" class="headerlink" title="Automated Installation"></a>Automated Installation</h3><p>Would it not be nice if one could create virtual machines from templates without having to enter any details? Yeah, Microsoft has thought of that. There’s this feature called answer files, which enter the settings for you. You can use answer files to <a href="https://technet.microsoft.com/en-us/library/cc749415.aspx" target="_blank" rel="noopener">automate normal installations of Windows</a>, but they also work together with Syspreped images. One way of <a href="https://technet.microsoft.com/en-us/library/cc749415%28v=ws.10%29.aspx" target="_blank" rel="noopener">how to make Windows load an answer file</a> is to place it in the folder <code>C:\Windows\Panther\</code> with the name <em>unattend.xml</em>.</p>
<p>Once the bootup configuration is complete, the installer process removes sensible data (such as password and product key) from that file by replacing them with <code>*SENSITIVE*DATA*DELETED*</code>.</p>
<p>There’s an official tool from Microsoft for creating answer files which is named Windows System Image Manager (SIM), and it’s part of the <a href="https://www.microsoft.com/en-US/download/confirmation.aspx?id=39982" target="_blank" rel="noopener">Windows Assessment and Deployment Kit</a>. Personally, I think that this application is a mess. It’s way to complicated to make me even want to try to use it.</p>
<p>The site <a href="http://windowsafg.no-ip.org" target="_blank" rel="noopener">Windows Answer File Generator</a> comes to rescue. From there you can generate answer files for all Windows operating systems, but with the limitation that it does not offer the same flexibility as Windows SIM. For example, it can not add instructions for <a href="http://www.windows-noob.com/forums/index.php?/topic/578-how-can-i-join-a-domain-using-windows-sim/" target="_blank" rel="noopener">automatically joining a domain</a>.</p>
<p>In the <a href="https://raw.githubusercontent.com/johanclasson/PowerShell/master/HyperV/unattend-ws2012r2.xml" target="_blank" rel="noopener">answer file I used preparing this post</a>, I inserted <em>underscore tokens</em> in place of some fields. The function in the PowerShell Module replace them when creating virtual machines from that template.</p>
<p>To create the <em>unattend.xml</em> file on your template VHDX you can mount it with PowerShell, for example in the following way.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Mount-DiskImage C:\Hyper-V\Templateswin2012r2_template.vhdx</span><br><span class="line">$url &#x3D; &quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;johanclasson&#x2F;PowerShell&#x2F;master&#x2F;HyperV&#x2F;unattend-ws2012r2.xml&quot;</span><br><span class="line">Invoke-WebRequest $url -OutFile F:\Windows\Panther\unattend.xml</span><br><span class="line">Dismount-DiskImage C:\Hyper-V\Templateswin2012r2_template.vhdx</span><br></pre></td></tr></table></figure>

<h3 id="Alternative-Way-to-Create-Template-VHDX"><a href="#Alternative-Way-to-Create-Template-VHDX" class="headerlink" title="Alternative Way to Create Template VHDX"></a>Alternative Way to Create Template VHDX</h3><p>When creating your template, instead of installing the operating system and runing Sysprep manually you can use a tool. I have found the TechNet Scriptcenter <a href="https://gallery.technet.microsoft.com/scriptcenter/Convert-WindowsImageps1-0fe23a8f" target="_blank" rel="noopener">Convert-WindowsImage.ps1</a> which can create sysprepped VHDX images from .iso-files.</p>
<p>I find this script to be too massive to use, and instead prefer to do the template myself. Creating templates is not something that I do often, so I do not have so much to gain from automating that activity.</p>
<h2 id="Invoking-the-Hyper-V-Environment-Templating-Function"><a href="#Invoking-the-Hyper-V-Environment-Templating-Function" class="headerlink" title="Invoking the Hyper-V Environment Templating Function"></a>Invoking the Hyper-V Environment Templating Function</h2><p>To run the PowerShell function which creates the virtual machines you can either install the module, or just copy the .ps1-file and run it as a script.</p>
<p>A <a href="http://blogs.technet.com/b/heyscriptingguy/archive/2010/01/21/hey-scripting-guy-january-21-2010.aspx" target="_blank" rel="noopener">PowerShell Module</a> is to some extent some functions that someone has packaged together. PowerShell monitors the folders in the environment variable <code>PSModulePath</code> for modules, and automatically imports them right when they you need them.</p>
<p>If you choose to install it as a module you have to rename the .ps1-files to .psm1, or you can follow the instructions in my PowerShell Repo Readme under <a href="https://github.com/johanclasson/PowerShell/blob/master/README.md#get-started" target="_blank" rel="noopener">Getting started</a>. I prefer to have my module scripts as .ps1-files when I develop them. Once I decide to install a new version of a module, I have them renamed in the install process.</p>
<p>To invoke the Hyper-V Environment Templating function, type <code>New-VMFromConfig -Path C:\PathTo\MyConfig.xml</code>. I you like you can use the <code>-Config</code> parameter instead and pass in an <code>[xml]</code> object.</p>
<p>The XML content might look something like this:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">VMSwitches</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">InternalVMSwitch</span> <span class="attr">name</span>=<span class="string">"LocalComputer"</span> <span class="attr">dns</span>=<span class="string">"10.0.0.1"</span> <span class="attr">ip</span>=<span class="string">"10.0.0.2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ExternalVMSwitch</span> <span class="attr">name</span>=<span class="string">"ExternalEthernet"</span> <span class="attr">netAdapterName</span>=<span class="string">"Ethernet"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- I did not bother to handle private network switches since I never use them. --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">VMSwitches</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">VMs</span> <span class="attr">root</span>=<span class="string">"C:\Hyper-V"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Example 1: Create VM from Template --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">VM</span> <span class="attr">name</span>=<span class="string">"Dev-Frontend"</span> <span class="attr">switches</span>=<span class="string">"LocalComputer,ExternalEthernet"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">startupBytes</span>=<span class="string">"512MB"</span> <span class="attr">dynamicMemory</span>=<span class="string">"false"</span> <span class="attr">processorCount</span>=<span class="string">"4"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">MoveVhd</span> <span class="attr">path</span>=<span class="string">"C:\Hyper-V\Templates\Copies\win2012r2*.vhdx"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ReplaceContent</span> <span class="attr">pathRelativeRoot</span>=<span class="string">"Windows\Panther\unattend.xml"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">"__Locale__"</span> <span class="attr">value</span>=<span class="string">"041d:0000041d"</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">"__TimeZone__"</span> <span class="attr">value</span>=<span class="string">"W. Europe Standard Time"</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">"__ComputerName__"</span> <span class="attr">value</span>=<span class="string">"Frontend"</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">"__ProductKey__"</span> <span class="attr">value</span>=<span class="string">"AAAAA-BBBBB-CCCCC-DDDDD-EEEEE"</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">"__Password__"</span> <span class="attr">value</span>=<span class="string">"p@ssw0rd"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ReplaceContent</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">MoveVhd</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">VM</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Example 2: Create VM with dvd and new disk --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">VM</span> <span class="attr">name</span>=<span class="string">"Dev-Backend"</span> <span class="attr">switches</span>=<span class="string">"LocalComputer"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">DvdDrive</span> <span class="attr">path</span>=<span class="string">"C:\iso\dvd.iso"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Vhd</span> <span class="attr">size</span>=<span class="string">"120GB"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">VM</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">VMs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>New virtual machines are created under the <code>&lt;VMs&gt;</code> root attribute in a folder that matches the name of the virtual machine.</p>
<p>The supported VHD tags are <code>&lt;MoveVhd path=&quot;...&quot;&gt;</code>, <code>&lt;CopyVhd path=&quot;...&quot;&gt;</code>, <code>&lt;DvdDrive path=&quot;...&quot;&gt;</code>, and <code>&lt;Vhd size=&quot;...&quot;&gt;</code>. The latter will create a new disk of the specified size. All three VHD tags can have a filename attribute which if set, specifies the name of the VHD file in the virtual machine folder.</p>
<p>Both the <code>&lt;CopyVhd&gt;</code> and <code>&lt;MoveVhd&gt;</code> supports the <code>&lt;ReplaceContent&gt;</code> tag which makes the answer file <em>underscore token</em> update possible. An advantage of moving a template VHD over copying it, is that it’s faster. The downside is that the template VHDs will no longer be available for future use. But if you create copies of your template VHD in advance you can overcome this. Since the VHD size of a clean install of Windows Server 2012 R2 Core is so small, space should not be an issue.</p>
<p>The <code>&lt;MoveVhd&gt;</code> path attribute supports wildcard matching. It picks the first file that matches the expression.</p>
<h2 id="Tricks-and-Tweaks"><a href="#Tricks-and-Tweaks" class="headerlink" title="Tricks and Tweaks"></a>Tricks and Tweaks</h2><h3 id="Installing-Windows-Server-2012-R2-AD-DNS-and-DHCP"><a href="#Installing-Windows-Server-2012-R2-AD-DNS-and-DHCP" class="headerlink" title="Installing Windows Server 2012 R2 AD, DNS and DHCP"></a>Installing Windows Server 2012 R2 AD, DNS and DHCP</h3><p>Name resolution and IP address distribution in Hyper-V is poor without a dedicated DNS and DHCP within the network. If you run your virtual machines on an external network, all is fine. But if you use internal or private networks you have to host these services yourself. Your would normally also need to connect to an Active Directory.  </p>
<p>To solve these problems all in one you can configure an instance of Windows Server 2012 R2 to act as both AD, DNS and DHCP-server.</p>
<p>I found a <a href="https://myvirtualcloud.wordpress.com/2012/12/21/installing-windows-server-2012-ad-dns-and-dhcp/" target="_blank" rel="noopener">blog post written by Ivo Bruinewoud</a> which describe an easy way to do this with PowerShell. Here is a slightly modified version:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Static IP</span><br><span class="line">New-NetIPAddress 10.0.0.1 -InterfaceAlias &quot;Ethernet&quot; -PrefixLength 24</span><br><span class="line">Set-DnsClientServerAddress -InterfaceAlias &quot;Ethernet&quot; -ServerAddresses 127.0.0.1</span><br><span class="line"></span><br><span class="line"># AD</span><br><span class="line">Install-WindowsFeature AD-Domain-Services -IncludeManagementTools</span><br><span class="line">Install-ADDSForest -DomainName classon.eu</span><br><span class="line"></span><br><span class="line"># DHCP (granted that the name of the computer is DC01)</span><br><span class="line">Install-WindowsFeature DHCP -IncludeManagementTools</span><br><span class="line">Add-DhcpServerv4Scope -name &quot;My Scope&quot; -StartRange 10.0.0.100 -EndRange 10.0.0.200 -SubnetMask 255.255.255.0</span><br><span class="line">Set-DhcpServerv4OptionValue -DnsDomain classon.eu -DnsServer 10.0.0.1</span><br><span class="line">Add-DhcpServerInDC -DnsName dc01.classon.eu</span><br><span class="line"></span><br><span class="line"># User</span><br><span class="line">New-ADUser -SamAccountName johan -AccountPassword (ConvertTo-SecureString &quot;p@ssw0rd&quot; -AsPlainText -Force) -name &quot;johan&quot; -enabled $true -PasswordNeverExpires $true -ChangePasswordAtLogon $false</span><br><span class="line">Add-ADPrincipalGroupMembership -Identity &quot;CN&#x3D;johan,CN&#x3D;Users,DC&#x3D;classon,DC&#x3D;eu&quot; -MemberOf &quot;CN&#x3D;Enterprise Admins,CN&#x3D;Users,DC&#x3D;classon,DC&#x3D;eu&quot;,&quot;CN&#x3D;Domain Admins,CN&#x3D;Users,DC&#x3D;classon,DC&#x3D;eu&quot;</span><br></pre></td></tr></table></figure>

<p>The PowerShell command to join a client machine to a domain is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Execute on the client machine</span><br><span class="line">Add-Computer -DomainName classon.eu -Restart</span><br></pre></td></tr></table></figure>

<h3 id="Switching-Between-GUI-and-No-GUI-in-Windows-Server"><a href="#Switching-Between-GUI-and-No-GUI-in-Windows-Server" class="headerlink" title="Switching Between GUI and No GUI in Windows Server"></a>Switching Between GUI and No GUI in Windows Server</h3><p>Sometimes it will be a pain to try to configure something that you know is easy if you have a GUI, but which isn’t when you are on a Windows Server Core instance. In those cases you can use <code>Install-WindowsFeature</code> to install the GUI, just to make your configuration, and then uninstall it again with <code>Uninstall-WindowsFeature</code> when you’re done.</p>
<p>If you invoke the Get-WindowsFeature on a Core instance, you will find the GUI related features looking like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Display Name                                            Name                       Install State</span><br><span class="line">------------                                            ----                       -------------</span><br><span class="line">[X] User Interfaces and Infrastructure                  User-Interfaces-Infra          Installed</span><br><span class="line">    [ ] Graphical Management Tools and Infrastructure   Server-Gui-Mgmt-Infra            Removed</span><br><span class="line">    [ ] Desktop Experience                              Desktop-Experience               Removed</span><br><span class="line">    [ ] Server Graphical Shell                          Server-Gui-Shell                 Removed</span><br></pre></td></tr></table></figure>

<p>And if invoked on a full installation, they look like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Display Name                                            Name                       Install State</span><br><span class="line">------------                                            ----                       -------------</span><br><span class="line">[X] User Interfaces and Infrastructure                  User-Interfaces-Infra          Installed</span><br><span class="line">    [X] Graphical Management Tools and Infrastructure   Server-Gui-Mgmt-Infra          Installed</span><br><span class="line">    [ ] Desktop Experience                              Desktop-Experience             Available</span><br><span class="line">    [X] Server Graphical Shell                          Server-Gui-Shell               Installed</span><br></pre></td></tr></table></figure>

<p>If a Windows Feature is <em>Available</em>, or <em>Removed</em> and you have got access to the internet, then you can install it without having any installation media. If that is not the case, you have to insert the .iso-file with the same version of the operating system in the DVD drive and specify the <code>Source</code> parameter. Follow <a href="https://support.microsoft.com/en-us/kb/2913316" target="_blank" rel="noopener">these instructions</a> for guidance.</p>
<h3 id="Setting-up-PowerShell-Remoting"><a href="#Setting-up-PowerShell-Remoting" class="headerlink" title="Setting up PowerShell Remoting"></a>Setting up PowerShell Remoting</h3><p>When you deal with servers that has not got the features <em>Server-Gui-Shell</em> or <em>Server-Gui-Mgmt-Infra</em> activated, I think that it’s cumbersome to use remote desktop or the Hyper-V Virtual Machine Connection to connect to them. A more elegant solution is to use PowerShell Remoting, although it can be a bit hard to configure when not connected to a domain, such as in a workspace environment or when your try to connect to a machine from outside a domain. When connecting to a domain in an virtual isolated network from your host machine this will essentially be the case.</p>
<p>To get PowerShell Remoting to work on my Windows 8.1 laptop, I had to run the following commands:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Enable-PSRemoting ?Force -SkipNetworkProfileCheck</span><br><span class="line">Set-Item wsman:localhost\client\trustedhosts -Value *</span><br></pre></td></tr></table></figure>

<p>Depending on the network confirmation of your host computer, you might not need the <code>-SkipNetworkProfileCheck</code> parameter.</p>
<h3 id="Setting-up-Name-Resolution-to-Work-with-Virtual-Network"><a href="#Setting-up-Name-Resolution-to-Work-with-Virtual-Network" class="headerlink" title="Setting up Name Resolution to Work with Virtual Network"></a>Setting up Name Resolution to Work with Virtual Network</h3><p>To make name resolution between your host and virtual machines to work, they need to be on the same subnet. Network Discovery is by default rejected by the windows firewall. You can enable it with the PowerShell command <code>Enable-NetFirewallRule NETDIS-NB_Name-In-UDP</code>.</p>
<p>I like to have my machines answering to Ping. When you are already at it, enable the firewall rule <code>FPS-ICMP4-ERQ-In</code> as well.</p>
<p>If you set the DNS address of the network adapter to be that of the DNS server, you can use the DNS server for name resolution. But since your host machine is outside the domain, you have to use the complete domain address. For example, <code>frontend.classon.eu</code>.</p>
<p>Also, PowerShell Remoting will not work if the IP address of the host is on another subnet than of the virtual machines.</p>
<h2 id="Future-Improvement"><a href="#Future-Improvement" class="headerlink" title="Future Improvement"></a>Future Improvement</h2><p>It would be nice to be able to have virtual machines being able to automatically join a domain.</p>
<p>For this to be possible, I have to solve two problems. First, I have to update the answer file to also include instructions for how to join a domain. Either I have to click through the Windows SIM application, or find someone else that has managed to do it and copy some lines from their xml-file. TechNet has some <a href="https://technet.microsoft.com/sv-se/library/cc732280.aspx" target="_blank" rel="noopener">sample answer files</a> for older operating systems that seams interesting. Hopefully they will also work for Windows Server 2012 R2.</p>
<p>Second, I need to make a PowerShell function that can start virtual machines. When creating a new environment with network isolation there is obviously no domain controller already present. Hence there might be an error if they start simultaneously. The function can solve this by waiting for any DCs to boot up before it starts any other virtual machines.</p>
<p>As an alternative to using answer files for domain joining, I might consider to use PowerShell instead. What I have in mind is to wait for a DC to start up, and then invoking the domain join on the client machines through a remoting session.</p>
<p>I will try to address this in a blog post sometime in the future.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2015-06-01-Hyper-V-Environment-Templating/" data-id="ck93ug7vs0004dsyg0svi8y7q" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-05-27-Gör-ditt-nästa-certifieringstest-för-Microsoft-från-din-egen-dator!" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015-05-27-G%C3%B6r-ditt-n%C3%A4sta-certifieringstest-f%C3%B6r-Microsoft-fr%C3%A5n-din-egen-dator!/" class="article-date">
  <time datetime="2015-05-26T22:00:00.000Z" itemprop="datePublished">2015-05-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015-05-27-G%C3%B6r-ditt-n%C3%A4sta-certifieringstest-f%C3%B6r-Microsoft-fr%C3%A5n-din-egen-dator!/">Gör Ditt Nästa Certifieringstest För Microsoft Från Din Egen Dator!</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Att göra certifieringstest för Microsoft via tredjepartsleverantörer är krångligt. Särskilt när man bor i en lite mindre stad, så som exempelvis Örebro. Visserligen har vi nyligen fått ett Addskills Testcenter här, men det erbjuder bara att skriva certifieringstest en gång i månaden.</p>
<p>När Microsoft bytte leverantör av certifieringstest från Prometric till Pearson VUE erbjuds ett nytt sätt att göra proven, nämligen via så kallade <em>Online Proctored Exams</em>. Även om det är lite krångel med att få igång det tekniska är det värt att överväga att göra sina examen på det här sättet. Och då inte bara på grund av förenklad logistik. Kostnaden för ett certifieringstest via Addskills är beroende på ort mellan 2 000 - 3 000 SEK. Gör man det via ett <em>Online Proctored Exam</em> kostar det istället 125 EUR. </p>
<h2 id="Hur-bokar-man-certifieringstest-for-Microsoft"><a href="#Hur-bokar-man-certifieringstest-for-Microsoft" class="headerlink" title="Hur bokar man certifieringstest för Microsoft?"></a>Hur bokar man certifieringstest för Microsoft?</h2><p>För att boka sitt provtillfälle går man in på <a href="https://www.microsoft.com/learning/en-us/" target="_blank" rel="noopener">Microsoft Learning (en-us)</a>. Notera att länken går till den amerikanska varianten. Märkligt nog så kommer man till en felsida om man använder <a href="https://www.microsoft.com/learning/" target="_blank" rel="noopener">Microsoft Learning</a>. Det har varit så här i alla fall under senaste månaden. Gissningsvis så är det en regional sida för besökare från Sverige som är trasig.</p>
<p>Väl där klickar du på <em>Register for exam</em>, och följer guiden för att göra certifieringstestet som ett <em>Online Proctored Exam</em>.</p>
<p>Notera adressuppgifterna som du anger under bokningen. Om du blir tvungen att ringa supporten kommer du behöva uppge dessa för att kunna styrka din identitet.</p>
<h2 id="Hur-gor-man"><a href="#Hur-gor-man" class="headerlink" title="Hur gör man?"></a>Hur gör man?</h2><p>Programvaran för certifieringstestet installerar du genom att göra <em>System Test 1</em> på <a href="http://www.pearsonvue.com/microsoft/op/" target="_blank" rel="noopener">Pearson VUEs Microsoft-sida</a>. Där finns även information om regler och teknikaliteter som rör testet.</p>
<p>Under själva tillfället blir man övervakad via webbkamera och mikrofon. Innan så ombeds man filma runt i rummet så att det inte finns några fusklappar eller dylikt. Av den här anledningen är det smidigt att ha en extern webbkamera så att det är lättare att filma i olika vinklar. Att bära runt en bärbar dator fungerar, men är lite klumpigt. Särskilt om man, som Pearson VUE rekommenderar, använder ethernet-sladd istället för WIFI.</p>
<p>Man måste också visa upp legitimation för kontrollanten. Denne behöver kunna läsa av giltighetstiden utan att bilden är suddig. Därför behöver man ha en webbkamera med relativt kort fokusavstånd. Vanligtvis är det bara webbkameror med autofokus som klarar av detta. </p>
<p>Jag rekommenderar <a href="https://www.microsoft.com/hardware/sv-se/p/lifecam-studio#details" target="_blank" rel="noopener">Microsoft LifeCam Studio</a>. Runt 600kr för en webbkamera kan verka överdrivet, men den är faktiskt värd varenda krona. Dessutom behöver man inte installera några drivrutiner manuellt för att använda den här kameran. Det är bara att plugga in och köra!</p>
<h2 id="Hur-startar-man-sjalva-testet"><a href="#Hur-startar-man-sjalva-testet" class="headerlink" title="Hur startar man själva testet?"></a>Hur startar man själva testet?</h2><p>På <a href="https://www.microsoft.com/learning/en-us/dashboard.aspx" target="_blank" rel="noopener">Microsoft Learning Dashboard</a> kan man starta ett inbokat certifieringstest via länken <em>Start a previously scheduled online proctored exam</em>.</p>
<p>Innan du börjar testet är det är lämpligt att kontrollera att webbkameran och mikrofonen fungerar, samt att stänga ner övriga program på din dator så som exempelvis Skype och Outlook. Pearson VUE vill även att man temporärt ska stänga av sitt antivirusprogram.</p>
<p>Värt att notera är att tiden som är angiven för provtillfället är i <a href="http://en.wikipedia.org/wiki/Central_European_Time" target="_blank" rel="noopener">CET</a> eller <a href="http://en.wikipedia.org/wiki/Central_European_Summer_Time" target="_blank" rel="noopener">CEST</a> vilket lyckligtvis är ekvivalent med Svensk tid.</p>
<p>I samband med att programvaran för certifieringstestet installeras så läggs en genväg med namn <em>PVproctor</em> på skrivbordet. Observera att du inte ska använda denna. Om du startar programmet via genvägen så blir du promptad att mata in en niosiffrig accesskod. Kruxet är att du inte har tillgång till någon sådan. För att starta testet är man tvungen att göra det via hemsidan.</p>
<h2 id="Hur-gor-jag-om-nagot-inte-fungerar"><a href="#Hur-gor-jag-om-nagot-inte-fungerar" class="headerlink" title="Hur gör jag om något inte fungerar?"></a>Hur gör jag om något inte fungerar?</h2><p>Du kan ringa och prata med <a href="http://www.pearsonvue.com/microsoft/contact/" target="_blank" rel="noopener">supporten på Pearson VUE</a>. För oss i Sverige kontaktar man dem via <a href="tel:020798690">020-798690</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.classon.eu/2015-05-27-G%C3%B6r-ditt-n%C3%A4sta-certifieringstest-f%C3%B6r-Microsoft-fr%C3%A5n-din-egen-dator!/" data-id="ck93ug7vs0003dsyg3sbhh2aa" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/">2015</a><span class="archive-list-count">13</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019-05-31-Release-Notes-with-Azure-DevOps/">Release Notes With Azure DevOps</a>
          </li>
        
          <li>
            <a href="/2018-11-29-Asynchronously-Wait-for-Task-to-Complete-with-Timeout/">Asynchronously Wait for Task to Complete With Timeout</a>
          </li>
        
          <li>
            <a href="/2018-06-29-Get-started-with-invisible-reCAPTCHA/">Get Started With Invisible reCAPTCHA</a>
          </li>
        
          <li>
            <a href="/2018-05-09-Handle-Secrets-with-.NET-Core/">Handle Secrets With .NET Core</a>
          </li>
        
          <li>
            <a href="/2017-02-10-Creating-ARM-Service-Endpoints-from-Within-VSTS/">Creating ARM Service Endpoints From Within VSTS</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Johan Classon<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>